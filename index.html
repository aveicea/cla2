
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë©€í‹° ìº˜ë¦°ë” ë·°ì–´</title>
<style>
:root {
  --accent-color: #D1D1D1;
  --accent-hover-color: #3367d6;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
  background-color: #f5f5f5;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.header {
  background: white;
  padding: 16px 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  z-index: 100;
}

.view-selector {
  display: flex;
  gap: 8px;
}

.view-btn {
  padding: 8px 16px;
  border: 2px solid #e0e0e0;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.view-btn:hover {
  background: #f5f5f5;
  border-color: #d0d0d0;
}

.view-btn.active {
  background: var(--accent-color);
  border-color: var(--accent-color);
  color: white;
}

.nav-controls {
  display: flex;
  align-items: center;
  gap: 16px;
}

.nav-btn {
  padding: 8px 12px;
  border: none;
  background: #f5f5f5;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s ease;
  min-width: 36px;
}

.nav-btn:hover {
  background: var(--accent-color);
  color: white;
}

.current-date {
  font-size: 18px;
  font-weight: 600;
  min-width: 200px;
  text-align: center;
  color: #333;
}

.settings-btn {
  padding: 10px 14px;
  border: none;
  background: var(--accent-color);
  color: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s ease;
}

.settings-btn:hover {
  background: var(--accent-hover-color);
}

.settings-panel {
  position: fixed;
  right: -400px;
  top: 0;
  width: 380px;
  height: 100vh;
  background: white;
  box-shadow: -2px 0 20px rgba(0,0,0,0.15);
  z-index: 1000;
  overflow-y: auto;
  transition: right 0.3s ease;
  padding: 20px;
}

.settings-panel.open {
  right: 0;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.overlay.show {
  opacity: 1;
  visibility: visible;
}

.settings-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 20px;
  color: #333;
}

.toggle-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  cursor: pointer;
  border-bottom: 1px solid #e0e0e0;
  margin-bottom: 16px;
  font-weight: 600;
}

.toggle-header:hover {
  background: #f8f9fa;
  margin: 0 -8px 16px;
  padding: 12px 8px;
  border-radius: 4px;
}

.color-picker-title {
  color: #333;
  font-size: 14px;
}

.toggle-icon {
  transition: transform 0.3s;
  font-size: 14px;
  color: #666;
}

.toggle-icon.expanded {
  transform: rotate(-180deg);
}

.toggle-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  margin-bottom: 20px;
}

.toggle-content.expanded {
  max-height: 500px;
}

.color-input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.color-picker-input {
  width: 50px;
  height: 40px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  cursor: pointer;
  background: none;
}

.color-text-input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-family: monospace;
  font-size: 13px;
}

.color-text-input:focus {
  outline: none;
  border-color: var(--accent-color);
}

.preset-colors {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
}

.preset-color {
  width: 40px;
  height: 30px;
  border-radius: 6px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.preset-color:hover {
  transform: scale(1.1);
  border-color: #333;
}

.calendar-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  margin-bottom: 8px;
  background: white;
  transition: all 0.2s;
}

.calendar-item:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-color: #d0d0d0;
}

.calendar-item.active {
  border-color: var(--accent-color);
  box-shadow: 0 0 0 2px rgba(209, 209, 209, 0.2);
}

.calendar-color-picker {
  width: 30px;
  height: 30px;
  border: 2px solid #e0e0e0;
  border-radius: 50%;
  cursor: pointer;
  background: none;
}

.calendar-info {
  flex: 1;
  min-width: 0;
}

.calendar-name {
  width: 100%;
  border: none;
  background: transparent;
  font-weight: 600;
  font-size: 14px;
  padding: 4px 0;
  color: #333;
}

.calendar-name:focus {
  outline: 1px solid var(--accent-color);
  background: white;
  padding: 4px 6px;
  border-radius: 4px;
}

.calendar-url {
  font-size: 11px;
  color: #666;
  margin-top: 2px;
  word-break: break-all;
}

.calendar-status {
  font-size: 10px;
  margin-top: 2px;
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
  font-weight: 500;
}

.calendar-status.success {
  background: #d4edda;
  color: #155724;
}

.calendar-status.error {
  background: #f8d7da;
  color: #721c24;
}

.calendar-status.loading {
  background: #d1ecf1;
  color: #0c5460;
}

.calendar-actions {
  display: flex;
  gap: 4px;
}

.toggle-btn {
  padding: 6px 8px;
  border: none;
  background: #f5f5f5;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
  min-width: 28px;
}

.toggle-btn:hover {
  background: #e0e0e0;
}

.toggle-btn.visible {
  background: #d4edda;
  color: #155724;
}

.toggle-btn.hidden {
  background: #f8d7da;
  color: #721c24;
}

.toggle-btn.reload-btn:hover {
  background: #ffc107;
  color: #212529;
}

.toggle-btn.remove-btn:hover {
  background: #dc3545;
  color: white;
}

.input-group {
  margin-bottom: 16px;
}

.input-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 6px;
  color: #555;
  font-size: 14px;
}

.input-group input,
.input-group select,
.input-group textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
}

.input-group input:focus,
.input-group select:focus,
.input-group textarea:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 2px rgba(209, 209, 209, 0.2);
}

.calendar-inputs {
  display: none;
}

.calendar-inputs.active {
  display: block;
}

.help-text {
  font-size: 11px;
  color: #666;
  margin-top: 4px;
  line-height: 1.4;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
  font-family: inherit;
}

.btn-primary {
  background: var(--accent-color);
  color: white;
}

.btn-primary:hover {
  background: var(--accent-hover-color);
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #545b62;
}

.backup-section, .debug-section {
  padding: 16px 0;
  border-top: 1px solid #e0e0e0;
  margin-top: 20px;
}

.debug-log {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 12px;
  max-height: 200px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 11px;
  line-height: 1.4;
  margin-top: 10px;
}

.debug-log div {
  margin-bottom: 4px;
  padding: 2px 0;
  color: #495057;
}

.calendar-container {
  flex: 1;
  padding: 0;
  overflow: hidden;
}

.calendar-content {
  height: 100%;
  background: white;
  overflow: hidden;
}

.calendar-grid {
  display: grid;
  height: 100%;
}

.month-view {
  grid-template-columns: repeat(7, 1fr);
  grid-template-rows: 40px repeat(6, 1fr);
}

.week-header {
  background: #f8f9fa;
  padding: 12px;
  font-weight: 600;
  text-align: center;
  border: 1px solid #e0e0e0;
  font-size: 14px;
  color: #495057;
}

.calendar-day {
  border: 1px solid #e0e0e0;
  padding: 8px;
  position: relative;
  overflow: hidden;
  background: white;
}

.calendar-day.other-month {
  background: #f8f9fa;
  color: #999;
}

.calendar-day.today {
  background: rgba(209, 209, 209, 0.2);
}

.day-number {
  font-weight: 600;
  margin-bottom: 4px;
  color: #333;
}

.event {
  background: #007bff;
  color: white;
  padding: 2px 6px;
  margin: 1px 0;
  border-radius: 3px;
  font-size: 11px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
  transition: opacity 0.2s;
}

.event:hover {
  opacity: 0.8;
}

.time-based-view {
  overflow-y: auto;
  height: 100%;
}

.time-slot {
  border-right: 1px solid #e0e0e0;
  border-bottom: 1px solid #e0e0e0;
  padding: 4px 8px;
  font-size: 12px;
  color: #666;
  background: #fafafa;
  text-align: right;
}

.day-cell {
  border: 1px solid #e0e0e0;
  position: relative;
  min-height: 25px;
  background: white;
}

.all-day-event {
  position: absolute;
  top: 2px;
  left: 2px;
  right: 2px;
  height: calc(100% - 4px);
  background: #007bff;
  color: white;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  overflow: hidden;
  display: flex;
  align-items: center;
  word-wrap: break-word;
  word-break: break-word;
  line-height: 1.2;
  min-height: 20px;
}

.time-event {
  position: absolute;
  background: #007bff;
  color: white;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 11px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  word-wrap: break-word;
  word-break: break-word;
  line-height: 1.2;
  min-height: 20px;
}

.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  font-size: 16px;
  color: #666;
}

.view-calendar-section {
  margin-bottom: 16px;
}

.view-calendar-list {
  margin-bottom: 8px;
}

.view-calendar-item {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s;
}

.view-calendar-item:hover {
  background: #f8f9fa;
}

.calendar-color-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
}
</style>
</head>
<body>
<div class="header">
  <div class="view-selector">
    <button class="view-btn active" onclick="setView('day')" id="dayBtn">ì¼</button>
    <button class="view-btn" onclick="setView('week')" id="weekBtn">ì£¼</button>
    <button class="view-btn" onclick="setView('month')" id="monthBtn">ì›”</button>
  </div>
  
  <div class="nav-controls">
    <button class="nav-btn" onclick="navigateCalendar(-1)">â€¹</button>
    <div class="current-date" id="currentDate"></div>
    <button class="nav-btn" onclick="navigateCalendar(1)">â€º</button>
    <button class="nav-btn" onclick="goToToday()">ğŸ“…</button>
  </div>
  
  <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
  
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-title">ë©€í‹° ìº˜ë¦°ë” ì„¤ì •</div>

<!-- ë·°ë³„ ìº˜ë¦°ë” ì„ íƒ -->
<div class="view-calendar-section">
  <div class="toggle-header" onclick="toggleSection('viewCalendarSettings', 'viewToggleIcon')">
    <div class="color-picker-title">ë·°ë³„ ìº˜ë¦°ë” ì„ íƒ</div>
    <div class="toggle-icon" id="viewToggleIcon">â–¼</div>
  </div>
  <div class="toggle-content" id="viewCalendarSettings">
    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
  </div>
</div>

<!-- í…Œë§ˆ ìƒ‰ìƒ -->
<div class="color-picker-group">
  <div class="toggle-header" onclick="toggleSection('themeColorContent', 'themeToggleIcon')">
    <div class="color-picker-title">í…Œë§ˆ ìƒ‰ìƒ</div>
    <div class="toggle-icon" id="themeToggleIcon">â–¼</div>
  </div>
  <div class="toggle-content" id="themeColorContent">
    <div class="color-input-row">
      <input type="color" class="color-picker-input" id="colorPicker" onchange="updateColorFromPicker()">
      <input type="text" class="color-text-input" id="colorText" placeholder="#D1D1D1" oninput="updateColorFromText()" maxlength="7">
    </div>
    <div class="preset-colors">
      <div class="preset-color" style="background-color: #4285f4;" onclick="setPresetColor('#4285f4')"></div>
      <div class="preset-color" style="background-color: #34a853;" onclick="setPresetColor('#34a853')"></div>
      <div class="preset-color" style="background-color: #ea4335;" onclick="setPresetColor('#ea4335')"></div>
      <div class="preset-color" style="background-color: #ffc107;" onclick="setPresetColor('#ffc107')"></div>
      <div class="preset-color" style="background-color: #9c27b0;" onclick="setPresetColor('#9c27b0')"></div>
      <div class="preset-color" style="background-color: #607d8b;" onclick="setPresetColor('#607d8b')"></div>
    </div>
  </div>
</div>

<!-- ì—°ë™ëœ ìº˜ë¦°ë” ëª©ë¡ -->
<div class="calendar-list-section">
  <div class="toggle-header" onclick="toggleSection('calendarListContent', 'listToggleIcon')">
    <div class="color-picker-title">ì—°ë™ëœ ìº˜ë¦°ë” ëª©ë¡</div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <button class="nav-btn" onclick="refreshAllCalendars()" title="ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
      <div class="toggle-icon" id="listToggleIcon">â–¼</div>
    </div>
  </div>
  <div class="toggle-content" id="calendarListContent">
    <div id="calendarList">
      <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
        ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì—ì„œ ìº˜ë¦°ë”ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!
      </p>
    </div>
  </div>
</div>

<!-- ìº˜ë¦°ë” ì¶”ê°€ -->
<div class="add-calendar-section">
  <div class="toggle-header" onclick="toggleSection('addCalendarContent', 'addToggleIcon')">
    <div class="color-picker-title">ìº˜ë¦°ë” ì¶”ê°€</div>
    <div class="toggle-icon" id="addToggleIcon">â–¼</div>
  </div>
  <div class="toggle-content" id="addCalendarContent">
    <div class="input-group">
      <label>ìº˜ë¦°ë” ìœ í˜•</label>
      <select id="calendarType" onchange="updateCalendarInputs()">
        <option value="ical">iCal ë§í¬ (.ics)</option>
        <option value="googlePublic">êµ¬ê¸€ ìº˜ë¦°ë” ê³µê°œ ë§í¬</option>
        <option value="api">êµ¬ê¸€ ìº˜ë¦°ë” API</option>
      </select>
    </div>
    
    <div class="input-group">
      <label>ìº˜ë¦°ë” ì´ë¦„</label>
      <input type="text" id="calendarName" placeholder="ì˜ˆ: ê°œì¸ ì¼ì •, ì—…ë¬´ ìº˜ë¦°ë”">
    </div>
    
    <div class="input-group">
      <label>ìº˜ë¦°ë” ìƒ‰ìƒ</label>
      <input type="color" id="calendarColor" value="#D1D1D1">
    </div>
    
    <div id="icalInputs" class="calendar-inputs active">
      <div class="input-group">
        <label>iCal ë§í¬</label>
        <textarea id="icalUrl" rows="3" placeholder="https://calendar.google.com/calendar/ical/.../basic.ics"></textarea>
        <div class="help-text">
          êµ¬ê¸€ ìº˜ë¦°ë” ì„¤ì • â†’ í†µí•© ë° ê³µìœ  â†’ ë¹„ê³µê°œ ì£¼ì†Œì˜ iCal ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.
        </div>
      </div>
    </div>
    
    <div id="googlePublicInputs" class="calendar-inputs">
      <div class="input-group">
        <label>êµ¬ê¸€ ìº˜ë¦°ë” ID</label>
        <input type="text" id="googleCalendarId" placeholder="ìº˜ë¦°ë”ID@group.calendar.google.com">
        <div class="help-text">
          ê³µê°œëœ êµ¬ê¸€ ìº˜ë¦°ë”ì˜ ìº˜ë¦°ë” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
          ì˜ˆ: ko.south_korea#holiday@group.v.calendar.google.com (í•œêµ­ ê³µíœ´ì¼)
        </div>
      </div>
    </div>
    
    <div id="apiInputs" class="calendar-inputs">
      <div class="input-group">
        <label>API í‚¤</label>
        <input type="text" id="apiKey" placeholder="Google Calendar API í‚¤">
      </div>
      <div class="input-group">
        <label>ìº˜ë¦°ë” ID</label>
        <input type="text" id="calendarId" placeholder="primary ë˜ëŠ” ì´ë©”ì¼@gmail.com">
      </div>
    </div>
    
    <button class="btn btn-primary" onclick="addCalendar()">ìº˜ë¦°ë” ì¶”ê°€</button>
  </div>
</div>

    <div class="backup-section">
      <div class="color-picker-title">ì„¤ì • ë°±ì—…/ë³µì›</div>
      <div style="display: flex; gap: 8px; margin-bottom: 10px;">
        <button class="btn btn-primary" onclick="exportCalendarSettings()">ì„¤ì • ë‚´ë ¤ë°›ê¸°</button>
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ì„¤ì • ê°€ì ¸ì˜¤ê¸°</button>
      </div>
      <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importCalendarSettings(this)">
      <div style="font-size: 11px; color: #666; margin-top: 5px;">
        ìº˜ë¦°ë” ì—°ë™ ì •ë³´, ìƒ‰ìƒ, ë·° ì„¤ì • ë“±ì„ ë°±ì—…í•˜ê³  ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>
    
    <div class="debug-section">
      <div class="color-picker-title">ë””ë²„ê·¸ ì •ë³´</div>
      <button class="btn btn-secondary" onclick="clearDebugLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
      <div id="debugLog" class="debug-log"></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSettings()"></div>

<div class="calendar-container">
  <div class="calendar-content" id="calendarContent">
    <div class="loading">ìº˜ë¦°ë”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
</div>

<script>
// === ì „ì—­ ìƒíƒœ ===
let currentView = 'day';
let currentDate = new Date();
let accentColor = '#D1D1D1';
let accentHoverColor = '#3367d6';
let calendars = [];
let debugMessages = [];
let viewCalendarSettings = {
  day: [],
  week: [],
  month: []
};

// === DOM ìš”ì†Œ ===
const settingsPanel = document.getElementById("settingsPanel");
const overlay = document.getElementById("overlay");
const colorPicker = document.getElementById("colorPicker");
const colorText = document.getElementById("colorText");
const currentDateElement = document.getElementById("currentDate");
const calendarContent = document.getElementById("calendarContent");
const calendarList = document.getElementById("calendarList");
const debugLog = document.getElementById("debugLog");

// === ë””ë²„ê·¸ ë¡œê·¸ ===
function addDebugLog(message) {
  const timestamp = new Date().toLocaleTimeString();
  debugMessages.push(`[${timestamp}] ${message}`);
  if (debugMessages.length > 50) debugMessages.shift();
  
  if (debugLog) {
    debugLog.innerHTML = debugMessages.map(msg => `<div>${msg}</div>`).join('');
    debugLog.scrollTop = debugLog.scrollHeight;
  }
  console.log(message);
}

function clearDebugLog() {
  debugMessages = [];
  if (debugLog) debugLog.innerHTML = '';
}

// === ìƒ‰ìƒ ê´€ë¦¬ ===
function darkenColor(hex, percent) {
  const num = parseInt(hex.replace("#", ""), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) - amt;
  const G = (num >> 8 & 0x00FF) - amt;
  const B = (num & 0x0000FF) - amt;
  return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
}

function setAccentColor(color) {
  accentColor = color;
  accentHoverColor = darkenColor(color, 15);
  
  document.documentElement.style.setProperty('--accent-color', color);
  document.documentElement.style.setProperty('--accent-hover-color', accentHoverColor);
  
  if (colorPicker) colorPicker.value = color;
  if (colorText) colorText.value = color.toUpperCase();
  
  saveToStorage();
}

function setPresetColor(color) {
  setAccentColor(color);
}

function updateColorFromPicker() {
  setAccentColor(colorPicker.value);
}

function updateColorFromText() {
  let color = colorText.value.trim();
  if (!color.startsWith('#')) color = '#' + color;
  if (/^#[0-9A-F]{6}$/i.test(color)) {
    setAccentColor(color);
  }
}

// === ì„¤ì • íŒ¨ë„ ===
function toggleSettings() {
  const isOpen = settingsPanel.classList.contains('open');
  if (isOpen) {
    closeSettings();
  } else {
    openSettings();
  }
}

function openSettings() {
  settingsPanel.classList.add('open');
  overlay.classList.add('show');
}

function closeSettings() {
  settingsPanel.classList.remove('open');
  overlay.classList.remove('show');
}

function toggleSection(contentId, iconId) {
  const content = document.getElementById(contentId);
  const icon = document.getElementById(iconId);
  
  content.classList.toggle('expanded');
  icon.classList.toggle('expanded');
}

// === ë·° ê´€ë¦¬ ===
function setView(viewMode) {
  currentView = viewMode;
  document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(viewMode + 'Btn').classList.add('active');
  updateCurrentDateDisplay();
  renderCalendar();
  saveToStorage();
}

function navigateCalendar(direction) {
  if (currentView === 'month') {
    currentDate.setMonth(currentDate.getMonth() + direction);
  } else if (currentView === 'week') {
    currentDate.setDate(currentDate.getDate() + (direction * 7));
  } else if (currentView === 'day') {
    currentDate.setDate(currentDate.getDate() + direction);
  }
  updateCurrentDateDisplay();
  renderCalendar();
}

function goToToday() {
  currentDate = new Date();
  updateCurrentDateDisplay();
  renderCalendar();
}

function updateCurrentDateDisplay() {
  if (currentView === 'day') {
    const options = { month: 'long', day: 'numeric', weekday: 'short' };
    const formatted = currentDate.toLocaleDateString('ko-KR', options);
    currentDateElement.textContent = formatted.replace(/(\d+ì¼)\s*(\([^)]+\))/, '$1 $2');
  } else if (currentView === 'week') {
    const options = { year: 'numeric', month: 'long' };
    currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
  } else {
    const options = { year: 'numeric', month: 'long' };
    currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
  }
}

// === ìº˜ë¦°ë” ì…ë ¥ í¼ ===
function updateCalendarInputs() {
  const type = document.getElementById('calendarType').value;
  
  document.querySelectorAll('.calendar-inputs').forEach(input => {
    input.classList.remove('active');
  });
  
  document.getElementById(type + 'Inputs').classList.add('active');
}

// === ìº˜ë¦°ë” ë°ì´í„° ë¡œë”© ===
async function loadCalendarEvents(calendar) {
  addDebugLog(`ì´ë²¤íŠ¸ ë¡œë“œ ì‹œì‘: ${calendar.name} (${calendar.type})`);
  
  if (calendar.type === 'ical') {
    await loadIcalEvents(calendar);
  } else if (calendar.type === 'googlePublic') {
    await loadGooglePublicEvents(calendar);
  } else if (calendar.type === 'api') {
    await loadApiEvents(calendar);
  }
}

async function loadIcalEvents(calendar) {
  const proxies = [
    `https://api.allorigins.win/get?url=${encodeURIComponent(calendar.url)}`,
    `https://cors-anywhere.herokuapp.com/${calendar.url}`,
    `https://corsproxy.io/?${encodeURIComponent(calendar.url)}`,
    `https://proxy.cors.sh/${calendar.url}`,
    `https://cors.sh/${calendar.url}`,
    `https://thingproxy.freeboard.io/fetch/${calendar.url}`,
    `https://yacdn.org/proxy/${calendar.url}`
  ];
  
  let lastError = null;
  
  for (const proxyUrl of proxies) {
    try {
      addDebugLog(`í”„ë¡ì‹œ ì‹œë„: ${proxyUrl.includes('allorigins') ? 'AllOrigins' : proxyUrl.split('/')[2]}`);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);
      
      const response = await fetch(proxyUrl, {
        method: 'GET',
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
          'Accept': 'text/calendar,text/plain,*/*',
          'Cache-Control': 'no-cache'
        },
        signal: controller.signal,
        mode: 'cors'
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      let icalData;
      if (proxyUrl.includes('allorigins')) {
        const data = await response.json();
        icalData = data.contents;
      } else {
        icalData = await response.text();
      }
      
      if (!icalData || typeof icalData !== 'string') {
        throw new Error('ì‘ë‹µì´ í…ìŠ¤íŠ¸ê°€ ì•„ë‹˜');
      }
      
      if (!icalData.includes('BEGIN:VCALENDAR') && !icalData.includes('BEGIN:VEVENT')) {
        throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ iCal ë°ì´í„°');
      }
      
      calendar.events = parseIcalData(icalData);
      addDebugLog(`iCal íŒŒì‹± ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
      return;
      
    } catch (error) {
      lastError = error;
      if (error.name === 'AbortError') {
        addDebugLog(`í”„ë¡ì‹œ íƒ€ì„ì•„ì›ƒ: ${proxyUrl.split('/')[2]}`);
      } else {
        addDebugLog(`í”„ë¡ì‹œ ì‹¤íŒ¨: ${proxyUrl.split('/')[2]} - ${error.message}`);
      }
      continue;
    }
  }
  
  throw new Error(`ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨. ë§ˆì§€ë§‰ ì˜¤ë¥˜: ${lastError.message}`);
}

async function loadGooglePublicEvents(calendar) {
  const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
  const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
  
  const apiKey = 'AIzaSyBNlYH01_9Hc5S1J9vuFmu2nUqBZJNAXxs';
  const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`API ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (!data.items) {
      throw new Error('ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    }
    
    calendar.events = data.items.map(event => {
      const startDate = event.start.dateTime || event.start.date;
      const endDate = event.end.dateTime || event.end.date;
      const startTime = new Date(startDate);
      const endTime = new Date(endDate);
      
      return {
        title: event.summary || 'ì œëª© ì—†ìŒ',
        date: startTime.toISOString().split('T')[0],
        startTime: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        endTime: event.end.dateTime ? 
          endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        time: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        color: calendar.color,
        description: event.description || '',
        location: event.location || ''
      };
    });
    
    addDebugLog(`êµ¬ê¸€ ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    
  } catch (error) {
    addDebugLog(`êµ¬ê¸€ ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    throw error;
  }
}

async function loadApiEvents(calendar) {
  const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
  const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
  
  const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${calendar.apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(`API ì˜¤ë¥˜ ${response.status}: ${errorData.error?.message || response.statusText}`);
    }
    
    const data = await response.json();
    
    calendar.events = data.items.map(event => {
      const startDate = event.start.dateTime || event.start.date;
      const endDate = event.end.dateTime || event.end.date;
      const startTime = new Date(startDate);
      const endTime = new Date(endDate);
      
      return {
        title: event.summary || 'ì œëª© ì—†ìŒ',
        date: startTime.toISOString().split('T')[0],
        startTime: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        endTime: event.end.dateTime ? 
          endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        time: event.start.dateTime ? 
          startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
          'ì¢…ì¼',
        color: calendar.color,
        description: event.description || '',
        location: event.location || ''
      };
    });
    
    addDebugLog(`API ìº˜ë¦°ë” ë¡œë“œ ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    
  } catch (error) {
    addDebugLog(`API ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    throw error;
  }
}

// === iCal íŒŒì‹± ===
function parseIcalData(icalText) {
  const events = [];
  const lines = icalText.split(/\r?\n/);
  let currentEvent = null;
  
  addDebugLog(`iCal íŒŒì‹± ì‹œì‘: ${lines.length}ì¤„`);
  
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i].trim();
    
    // ë©€í‹°ë¼ì¸ ì²˜ë¦¬
    while (i + 1 < lines.length && lines[i + 1].match(/^\s/)) {
      i++;
      line += lines[i].trim();
    }
    
    if (line === 'BEGIN:VEVENT') {
      currentEvent = {};
    } 
    else if (line === 'END:VEVENT' && currentEvent) {
      if (currentEvent.summary && currentEvent.dtstart) {
        const baseEvent = {
          id: currentEvent.uid || `event_${Date.now()}_${Math.random()}`,
          title: currentEvent.summary,
          date: currentEvent.date,
          start: currentEvent.date + 'T' + (currentEvent.startTime === 'ì¢…ì¼' ? '00:00:00' : currentEvent.startTime + ':00'),
          end: currentEvent.date + 'T' + (currentEvent.endTime === 'ì¢…ì¼' ? '23:59:59' : currentEvent.endTime + ':00'),
          time: currentEvent.time || 'ì¢…ì¼',
          startTime: currentEvent.startTime || currentEvent.time || 'ì¢…ì¼',
          endTime: currentEvent.endTime || currentEvent.time || 'ì¢…ì¼',
          description: currentEvent.description || '',
          location: currentEvent.location || '',
          rrule: currentEvent.rrule
        };
        
        // ë°˜ë³µ ì¼ì •ì¸ ê²½ìš°
        if (currentEvent.rrule) {
          addDebugLog(`ë°˜ë³µ ì¼ì • ë°œê²¬: ${baseEvent.title}, RRULE: ${currentEvent.rrule}`);
          
          const viewStart = new Date(currentDate.getFullYear(), currentDate.getMonth() - 2, 1);
          const viewEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 3, 0);
          
          const expandedEvents = expandRecurringEvent(baseEvent, viewStart, viewEnd);
          events.push(...expandedEvents);
          addDebugLog(`ë°˜ë³µ ì¼ì • í™•ì¥ ì™„ë£Œ: ${expandedEvents.length}ê°œ ì¸ìŠ¤í„´ìŠ¤`);
        } else {
          events.push(baseEvent);
        }
      }
      currentEvent = null;
    }
    else if (currentEvent) {
      const colonIndex = line.indexOf(':');
      if (colonIndex > 0) {
        const key = line.substring(0, colonIndex).split(';')[0];
        const value = line.substring(colonIndex + 1);
        
        switch (key) {
          case 'UID':
            currentEvent.uid = value;
            break;
          case 'SUMMARY':
            currentEvent.summary = decodeIcalText(value);
            break;
          case 'DESCRIPTION':
            currentEvent.description = decodeIcalText(value);
            break;
          case 'DTSTART':
            const startDate = parseIcalDate(value);
            if (startDate) {
              currentEvent.dtstart = startDate.date;
              currentEvent.date = startDate.date;
              currentEvent.time = startDate.time;
              currentEvent.startTime = startDate.time;
            }
            break;
          case 'DTEND':
            const endDate = parseIcalDate(value);
            if (endDate) {
              currentEvent.endTime = endDate.time;
            }
            break;
          case 'RRULE':
            currentEvent.rrule = value;
            addDebugLog(`RRULE íŒŒì‹±ë¨: ${value}`);
            break;
          case 'LOCATION':
            currentEvent.location = decodeIcalText(value);
            break;
        }
      }
    }
  }
  
  addDebugLog(`iCal íŒŒì‹± ì™„ë£Œ: ${events.length}ê°œ ì´ë²¤íŠ¸ ì¶”ì¶œ`);
  return events;
}

function decodeIcalText(text) {
  return text
    .replace(/\\n/g, ' ')
    .replace(/\\,/g, ',')
    .replace(/\\;/g, ';')
    .replace(/\\\\/g, '\\')
    .trim();
}

function parseIcalDate(dateString) {
  try {
    // YYYYMMDD í˜•ì‹ (ì¢…ì¼ ì´ë²¤íŠ¸)
    if (/^\d{8}$/.test(dateString)) {
      const year = parseInt(dateString.substring(0, 4));
      const month = parseInt(dateString.substring(4, 6));
      const day = parseInt(dateString.substring(6, 8));
      const date = new Date(year, month - 1, day);
      return {
        date: date.toISOString().split('T')[0],
        time: 'ì¢…ì¼'
      };
    }
    
    // YYYYMMDDTHHMMSS[Z] í˜•ì‹ (ì‹œê°„ í¬í•¨)
    if (/^\d{8}T\d{6}Z?$/.test(dateString)) {
      const year = parseInt(dateString.substring(0, 4));
      const month = parseInt(dateString.substring(4, 6));
      const day = parseInt(dateString.substring(6, 8));
      const hour = parseInt(dateString.substring(9, 11));
      const minute = parseInt(dateString.substring(11, 13));
      
      let date = new Date(year, month - 1, day, hour, minute);
      
      if (dateString.endsWith('Z')) {
        date = new Date(Date.UTC(year, month - 1, day, hour, minute));
      } else {
        date = new Date(year, month - 1, day, hour, minute);
      }
      
      return {
        date: date.toISOString().split('T')[0],
        time: date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false })
      };
    }
  } catch (e) {
    addDebugLog(`ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜: ${dateString} - ${e.message}`);
  }
  return null;
}

function expandRecurringEvent(event, viewStart, viewEnd) {
  const occurrences = [];
  const eventStart = new Date(event.start || event.date + 'T00:00:00');
  const eventEnd = new Date(event.end || event.date + 'T23:59:59');
  const eventDuration = eventEnd - eventStart;
  
  const rrule = event.rrule.replace('RRULE:', '').trim();
  const rules = {};
  rrule.split(';').forEach(part => {
    const [key, value] = part.split('=');
    if (key && value) {
      rules[key.trim()] = value.trim();
    }
  });
  
  let current = new Date(eventStart.getTime());
  const maxOccurrences = rules.COUNT ? Math.min(parseInt(rules.COUNT) + 5, 50) : 30;
  let count = 0;
  
  // ì‹œì‘ì¼ì´ ë·° ë²”ìœ„ë³´ë‹¤ ì´ì „ì´ë©´ ë·° ì‹œì‘ ê·¼ì²˜ë¡œ ì´ë™
  while (current < viewStart && count < maxOccurrences) {
    moveToNextOccurrence(current, rules);
    count++;
  }
  
  // ì‹¤ì œ ë°˜ë³µ ì¼ì • ìƒì„±
  count = 0;
  while (current <= viewEnd && count < maxOccurrences) {
    if (current >= viewStart) {
      const occurrenceStart = new Date(current.getTime());
      const occurrenceEnd = new Date(current.getTime() + eventDuration);
      
      const eventDate = current.toISOString().split('T')[0];
      const startTimeStr = event.startTime || event.time || 'ì¢…ì¼';
      const endTimeStr = event.endTime || event.time || 'ì¢…ì¼';
      
      occurrences.push({
        ...event,
        id: `${event.id}_${current.getTime()}`,
        date: eventDate,
        start: occurrenceStart.toISOString(),
        end: occurrenceEnd.toISOString(),
        startTime: startTimeStr,
        endTime: endTimeStr,
        time: startTimeStr,
        isRecurring: true,
        originalEventId: event.id
      });
      count++;
    }
    
    moveToNextOccurrence(current, rules);
    
    // ì œí•œ ì¡°ê±´ ì²´í¬
    if (rules.COUNT && count >= parseInt(rules.COUNT)) {
      addDebugLog(`COUNT ì œí•œ ë„ë‹¬: ${count}`);
      break;
    }
    
    if (rules.UNTIL) {
      let untilDate = null;
      try {
        if (rules.UNTIL.length === 8) {
          const year = parseInt(rules.UNTIL.substring(0, 4));
          const month = parseInt(rules.UNTIL.substring(4, 6)) - 1;
          const day = parseInt(rules.UNTIL.substring(6, 8));
          untilDate = new Date(year, month, day, 23, 59, 59);
        }
      } catch (e) {
        addDebugLog(`UNTIL íŒŒì‹± ì˜¤ë¥˜: ${e.message}`);
      }
      
      if (untilDate && current > untilDate) {
        addDebugLog(`UNTIL ë‚ ì§œ ë„ë‹¬: ${current.toISOString()}`);
        break;
      }
    }
  }
  
  return occurrences;
}

function moveToNextOccurrence(current, rules) {
  switch (rules.FREQ) {
    case 'DAILY':
      const dailyInterval = parseInt(rules.INTERVAL) || 1;
      current.setDate(current.getDate() + dailyInterval);
      break;
    case 'WEEKLY':
      const weekInterval = parseInt(rules.INTERVAL) || 1;
      if (rules.BYDAY) {
        const dayMap = {'MO': 1, 'TU': 2, 'WE': 3, 'TH': 4, 'FR': 5, 'SA': 6, 'SU': 0};
        const targetDays = rules.BYDAY.split(',').map(day => dayMap[day.trim()]);
        
        let nextDate = null;
        for (let i = 1; i <= 7 * weekInterval; i++) {
          const testDate = new Date(current.getTime());
          testDate.setDate(current.getDate() + i);
          if (targetDays.includes(testDate.getDay()) && (i > 7 * (weekInterval - 1))) {
            nextDate = testDate;
            break;
          }
        }
        if (nextDate) {
          current.setTime(nextDate.getTime());
        } else {
          current.setDate(current.getDate() + (7 * weekInterval));
        }
      } else {
        current.setDate(current.getDate() + (7 * weekInterval));
      }
      break;
    case 'MONTHLY':
      const monthInterval = parseInt(rules.INTERVAL) || 1;
      current.setMonth(current.getMonth() + monthInterval);
      break;
  }
}

// === ìº˜ë¦°ë” ê´€ë¦¬ ===
function updateCalendarColor(calendarId, newColor) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.color = newColor;
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ìƒ‰ìƒ ë³€ê²½: ${calendar.name} â†’ ${newColor}`);
  }
}

function updateCalendarName(calendarId, newName) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar && newName.trim()) {
    calendar.name = newName.trim();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ì´ë¦„ ë³€ê²½: ${newName}`);
  }
}

function updateCalendarStatus(calendarId, status, message = '') {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.status = status;
    calendar.statusMessage = message;
    updateCalendarList();
  }
}

function updateCalendarList() {
  if (calendars.length === 0) {
    calendarList.innerHTML = `
      <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
        ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì—ì„œ ìº˜ë¦°ë”ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!
      </p>
    `;
    return;
  }
  
  calendarList.innerHTML = calendars.map(calendar => `
    <div class="calendar-item ${calendar.visible ? 'active' : ''}" data-id="${calendar.id}">
      <input type="color" value="${calendar.color}" 
             onchange="updateCalendarColor('${calendar.id}', this.value)" 
             class="calendar-color-picker" 
             title="ìº˜ë¦°ë” ìƒ‰ìƒ ë³€ê²½">
      <div class="calendar-info">
        <input class="calendar-name" value="${calendar.name}" 
               onchange="updateCalendarName('${calendar.id}', this.value)"
               onblur="updateCalendarName('${calendar.id}', this.value)">
        <div class="calendar-url">${calendar.type === 'sample' ? 'ìƒ˜í”Œ ë°ì´í„°' : 
          (calendar.url || calendar.calendarId || '').substring(0, 30)}${(calendar.url || calendar.calendarId || '').length > 30 ? '...' : ''}</div>
        <div class="calendar-status ${calendar.status}">${calendar.statusMessage || calendar.status}</div>
      </div>
      <div class="calendar-actions">
        <button class="toggle-btn ${calendar.visible ? 'visible' : 'hidden'}" 
                onclick="toggleCalendarVisibility('${calendar.id}')" 
                title="${calendar.visible ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ì´ê¸°'}">
          ${calendar.visible ? 'ğŸ‘ï¸' : 'ğŸš«'}
        </button>
        <button class="toggle-btn reload-btn" onclick="reloadCalendar('${calendar.id}')" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        <button class="toggle-btn remove-btn" onclick="removeCalendar('${calendar.id}')" title="ì‚­ì œ">âœ˜</button>
      </div>
    </div>
  `).join('');
  
  updateViewCalendarSettings();
}

function updateViewCalendarSettings() {
  const container = document.getElementById('viewCalendarSettings');
  if (!container) return;
  
  if (calendars.length === 0) {
    container.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center; padding: 10px;">ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  const views = [
    { key: 'day', name: 'ì¼ê°„ë·°' },
    { key: 'week', name: 'ì£¼ê°„ë·°' },
    { key: 'month', name: 'ì›”ê°„ë·°' }
  ];
  
  container.innerHTML = views.map(view => `
    <div class="view-calendar-section">
      <div style="font-weight: bold; margin-bottom: 8px; color: #333;">${view.name}</div>
      <div class="view-calendar-list">
        ${calendars.map(calendar => `
          <label class="view-calendar-item">
            <input type="checkbox" 
                   ${viewCalendarSettings[view.key].includes(calendar.id) ? 'checked' : ''}
                   onchange="toggleViewCalendar('${view.key}', '${calendar.id}')"
                   style="margin-right: 8px;">
            <span class="calendar-color-dot" style="background-color: ${calendar.color};"></span>
            <span>${calendar.name}</span>
          </label>
        `).join('')}
      </div>
      <div style="margin-top: 8px;">
        <button class="btn btn-secondary" onclick="selectAllViewCalendars('${view.key}')" style="font-size: 11px; padding: 4px 8px;">ì „ì²´ ì„ íƒ</button>
        <button class="btn btn-secondary" onclick="deselectAllViewCalendars('${view.key}')" style="font-size: 11px; padding: 4px 8px; margin-left: 4px;">ì „ì²´ í•´ì œ</button>
      </div>
    </div>
  `).join('');
}

function toggleViewCalendar(viewType, calendarId) {
  const index = viewCalendarSettings[viewType].indexOf(calendarId);
  if (index > -1) {
    viewCalendarSettings[viewType].splice(index, 1);
  } else {
    viewCalendarSettings[viewType].push(calendarId);
  }
  saveToStorage();
  renderCalendar();
}

function selectAllViewCalendars(viewType) {
  viewCalendarSettings[viewType] = calendars.map(cal => cal.id);
  updateViewCalendarSettings();
  saveToStorage();
  renderCalendar();
}

function deselectAllViewCalendars(viewType) {
  viewCalendarSettings[viewType] = [];
  updateViewCalendarSettings();
  saveToStorage();
  renderCalendar();
}

async function reloadCalendar(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (!calendar) return;
  
  updateCalendarStatus(calendarId, 'loading', 'ìƒˆë¡œê³ ì¹¨ ì¤‘...');
  addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨: ${calendar.name}`);
  
  try {
    calendar.events = [];
    await loadCalendarEvents(calendar);
    updateCalendarStatus(calendarId, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${calendar.name}`);
  } catch (error) {
    updateCalendarStatus(calendarId, 'error', error.message);
    addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
  }
}

function toggleCalendarVisibility(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.visible = !calendar.visible;
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ê°€ì‹œì„± ë³€ê²½: ${calendar.name} - ${calendar.visible ? 'ë³´ì„' : 'ìˆ¨ê¹€'}`);
  }
}

function removeCalendar(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendars = calendars.filter(c => c.id !== calendarId);
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ì‚­ì œë¨: ${calendar.name}`);
  }
}

async function refreshAllCalendars() {
  addDebugLog('ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
  
  for (const calendar of calendars) {
    if (calendar.type !== 'sample') {
      updateCalendarStatus(calendar.id, 'loading', 'ìƒˆë¡œê³ ì¹¨ ì¤‘...');
      try {
        calendar.events = [];
        await loadCalendarEvents(calendar);
        updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
      } catch (error) {
        updateCalendarStatus(calendar.id, 'error', error.message);
        addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
      }
    }
  }
  
  renderCalendar();
  saveToStorage();
  addDebugLog('ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}

async function addCalendar() {
  const type = document.getElementById('calendarType').value;
  const name = document.getElementById('calendarName').value.trim();
  const color = document.getElementById('calendarColor').value;
  
  if (!name) {
    alert('ìº˜ë¦°ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  let url = '';
  let calendarId = '';
  let apiKey = '';
  
  
  if (type === 'ical') {
    url = document.getElementById('icalUrl').value.trim();
    if (!url || !url.includes('.ics')) {
      alert('ì˜¬ë°”ë¥¸ iCal ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  } else if (type === 'googlePublic') {
    calendarId = document.getElementById('googleCalendarId').value.trim();
    if (!calendarId) {
      alert('êµ¬ê¸€ ìº˜ë¦°ë” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  } else if (type === 'api') {
    apiKey = document.getElementById('apiKey').value.trim();
    calendarId = document.getElementById('calendarId').value.trim() || 'primary';
    if (!apiKey) {
      alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  const calendar = {
    id: Date.now().toString(),
    name: name,
    type: type,
    color: color,
    visible: true,
    url: url,
    calendarId: calendarId,
    apiKey: apiKey,
    events: [],
    status: 'loading',
    statusMessage: 'ë¡œë”© ì¤‘...'
  };
  
  addDebugLog(`ìº˜ë¦°ë” ì¶”ê°€ ì‹œì‘: ${name} (${type})`);
  
  calendars.push(calendar);
  updateCalendarList();
  
  try {
    await loadCalendarEvents(calendar);
    updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    addDebugLog(`ìº˜ë¦°ë” ë¡œë“œ ì„±ê³µ: ${name}, ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    renderCalendar();
    saveToStorage();
    
    // ì…ë ¥ í¼ ì´ˆê¸°í™”
    document.getElementById('calendarName').value = '';
    document.getElementById('icalUrl').value = '';
    document.getElementById('googleCalendarId').value = '';
    document.getElementById('apiKey').value = '';
    document.getElementById('calendarId').value = '';
    
    closeSettings();
  } catch (error) {
    updateCalendarStatus(calendar.id, 'error', error.message);
    addDebugLog(`ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${name} - ${error.message}`);
    alert('ìº˜ë¦°ë”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

// === ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ===
function saveToStorage() {
  try {
    const data = {
      view: currentView,
      currentDate: currentDate.toISOString(),
      accentColor: accentColor,
      accentHoverColor: accentHoverColor,
      viewCalendarSettings: viewCalendarSettings,
      calendars: calendars.map(cal => ({
        ...cal,
        events: cal.events || []
      }))
    };
    
    localStorage.setItem('multiCalendarData', JSON.stringify(data));
    addDebugLog('ì„¤ì •ì´ localStorageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    addDebugLog(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
  }
}

function loadFromStorage() {
  try {
    const data = localStorage.getItem('multiCalendarData');
    if (data) {
      const parsed = JSON.parse(data);
      currentView = parsed.view || 'day';
      if (parsed.currentDate) {
        currentDate = new Date(parsed.currentDate);
      }
      accentColor = parsed.accentColor || '#D1D1D1';
      accentHoverColor = parsed.accentHoverColor || darkenColor(accentColor, 15);
      viewCalendarSettings = parsed.viewCalendarSettings || { day: [], week: [], month: [] };
      calendars = parsed.calendars || [];
      
      // UI ë³µì›
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(currentView + 'Btn').classList.add('active');
      
      // ì €ì¥ëœ ìº˜ë¦°ë”ë“¤ì˜ ì´ë²¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ
      calendars.forEach(async (calendar) => {
        if (calendar.type !== 'sample' && (!calendar.events || calendar.events.length === 0)) {
          updateCalendarStatus(calendar.id, 'loading', 'ë¡œë”© ì¤‘...');
          try {
            await loadCalendarEvents(calendar);
            updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
          } catch (error) {
            updateCalendarStatus(calendar.id, 'error', error.message);
            addDebugLog(`ì €ì¥ëœ ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
          }
        } else {
          updateCalendarStatus(calendar.id, 'success', `${(calendar.events || []).length}ê°œ ì´ë²¤íŠ¸`);
        }
      });
      
      addDebugLog('ì„¤ì •ì´ localStorageì—ì„œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  } catch (e) {
    addDebugLog(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}`);
  }
}

function exportCalendarSettings() {
  try {
    const exportData = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      view: currentView,
      currentDate: currentDate.toISOString(),
      accentColor: accentColor,
      accentHoverColor: accentHoverColor,
      viewCalendarSettings: viewCalendarSettings,
      calendars: calendars.map(cal => ({
        id: cal.id,
        name: cal.name,
        type: cal.type,
        color: cal.color,
        visible: cal.visible,
        url: cal.url,
        calendarId: cal.calendarId,
        apiKey: cal.apiKey,
        status: cal.status,
        statusMessage: cal.statusMessage
      }))
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `ìº˜ë¦°ë”ì„¤ì •_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    addDebugLog(`ìº˜ë¦°ë” ì„¤ì • ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: ${calendars.length}ê°œ ìº˜ë¦°ë”`);
    alert('ìº˜ë¦°ë” ì„¤ì •ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    
  } catch (error) {
    addDebugLog(`ì„¤ì • ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`);
    alert('ì„¤ì • ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

async function importCalendarSettings(fileInput) {
  const file = fileInput.files[0];
  if (!file) return;
  
  try {
    const text = await file.text();
    const importData = JSON.parse(text);
    
    if (!importData.version) {
      throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.');
    }
    
    addDebugLog(`ì„¤ì • íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì‹œì‘: ${importData.calendars?.length || 0}ê°œ ìº˜ë¦°ë”`);
    
    // ê¸°ì¡´ ìº˜ë¦°ë” ë°±ì—… (sample ì œì™¸)
    const backupCalendars = calendars.filter(cal => cal.type === 'sample');
    
    // ì„¤ì • ë³µì›
    currentView = importData.view || 'day';
    if (importData.currentDate) {
      currentDate = new Date(importData.currentDate);
    }
    if (importData.accentColor) {
      setAccentColor(importData.accentColor);
    }
    if (importData.viewCalendarSettings) {
      viewCalendarSettings = importData.viewCalendarSettings;
    }
    
    calendars = [...backupCalendars];
    
    if (importData.calendars && Array.isArray(importData.calendars)) {
      for (const calData of importData.calendars) {
        if (calData.type === 'sample') continue;
        
        const calendar = {
          id: calData.id || Date.now().toString() + Math.random(),
          name: calData.name || 'ì´ë¦„ ì—†ìŒ',
          type: calData.type,
          color: calData.color || '#D1D1D1',
          visible: calData.visible !== false,
          url: calData.url,
          calendarId: calData.calendarId,
          apiKey: calData.apiKey,
          events: [],
          status: 'loading',
          statusMessage: 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'
        };
        
        calendars.push(calendar);
        updateCalendarStatus(calendar.id, 'loading', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        try {
          await loadCalendarEvents(calendar);
          updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
          addDebugLog(`ìº˜ë¦°ë” ë³µì› ì„±ê³µ: ${calendar.name}`);
        } catch (error) {
          updateCalendarStatus(calendar.id, 'error', error.message);
          addDebugLog(`ìº˜ë¦°ë” ë³µì› ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
        }
      }
    }
    
    // UI ì—…ë°ì´íŠ¸
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(currentView + 'Btn').classList.add('active');
    
    updateCurrentDateDisplay();
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    
    addDebugLog('ìº˜ë¦°ë” ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
    alert(`ìº˜ë¦°ë” ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.\në³µì›ëœ ìº˜ë¦°ë”: ${importData.calendars?.length || 0}ê°œ`);
    
  } catch (error) {
    addDebugLog(`ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`);
    alert('ì„¤ì • íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
  
  fileInput.value = '';
}

// === ë Œë”ë§ ===
function renderCalendar() {
  if (currentView === 'month') {
    renderMonthView();
  } else if (currentView === 'week') {
    renderWeekView();
  } else if (currentView === 'day') {
    renderDayView();
  }
}

function renderMonthView() {
  const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  const startDate = new Date(firstDay);
  const mondayOffset = (firstDay.getDay() + 6) % 7;
  startDate.setDate(startDate.getDate() - mondayOffset);
  
  const grid = document.createElement('div');
  grid.className = 'calendar-grid month-view';
  
  // ìš”ì¼ í—¤ë”
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  weekdays.forEach(day => {
    const header = document.createElement('div');
    header.className = 'week-header';
    header.textContent = day;
    grid.appendChild(header);
  });
  
  // ë‚ ì§œ ì…€
  const today = new Date();
  for (let i = 0; i < 42; i++) {
    const cellDate = new Date(startDate);
    cellDate.setDate(startDate.getDate() + i);
    
    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    
    if (cellDate.getMonth() !== currentDate.getMonth()) {
      cell.classList.add('other-month');
    }
    
    if (cellDate.toDateString() === today.toDateString()) {
      cell.classList.add('today');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = cellDate.getDate();
    cell.appendChild(dayNumber);
    
    const dayEvents = getAllEventsForDate(cellDate);
    dayEvents.slice(0, 4).forEach(event => {
      const eventDiv = document.createElement('div');
      eventDiv.className = 'event';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\nì‹œê°„: ${event.time}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
      cell.appendChild(eventDiv);
    });
    
    if (dayEvents.length > 4) {
      const moreDiv = document.createElement('div');
      moreDiv.className = 'event';
      moreDiv.style.backgroundColor = '#999';
      moreDiv.textContent = `+${dayEvents.length - 4}ê°œ ë”`;
      cell.appendChild(moreDiv);
    }
    
    grid.appendChild(cell);
  }
  
  calendarContent.innerHTML = '';
  calendarContent.appendChild(grid);
}

function renderWeekView() {
  const startOfWeek = new Date(currentDate);
  startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

  const container = document.createElement('div');
  container.style.padding = '20px';
  container.style.height = '600px';
  container.style.overflow = 'visible';

  const grid = document.createElement('div');
  grid.className = 'time-based-view week-view';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = `80px repeat(7, 1fr)`;
  grid.style.gridTemplateRows = `35px repeat(24, 25px)`;
  grid.style.gap = '0';
  grid.style.height = '500px';

  // ì‹œê°„ í—¤ë”
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = 'ì‹œê°„';
  timeHeader.style.gridRow = '1';
  timeHeader.style.gridColumn = '1';
  timeHeader.style.border = '1px solid #e0e0e0';
  timeHeader.style.backgroundColor = '#f5f5f5';
  timeHeader.style.padding = '8px';
  timeHeader.style.textAlign = 'center';
  grid.appendChild(timeHeader);

  // ìš”ì¼ í—¤ë”
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);

    const header = document.createElement('div');
    header.className = 'week-header';
    header.style.gridRow = '1';
    header.style.gridColumn = `${i + 2}`;
    header.style.border = '1px solid #e0e0e0';
    header.style.backgroundColor = '#f5f5f5';
    header.style.padding = '8px';
    header.style.textAlign = 'center';

    if (date.toDateString() === (new Date()).toDateString()) {
      header.style.backgroundColor = accentColor;
    }

    const dayName = document.createElement('div');
    dayName.textContent = weekdays[i];
    dayName.style.fontWeight = 'bold';
    header.appendChild(dayName);

    const dayNumber = document.createElement('div');
    dayNumber.textContent = date.getDate();
    dayNumber.style.fontSize = '0.9em';
    dayNumber.style.color = '#666';
    header.appendChild(dayNumber);

    grid.appendChild(header);
  }

  // ê° ë‚ ì§œë³„ ì…€ ì €ì¥ìš© ë°°ì—´
  const dayCells = Array.from({length: 7}, () => []);

  // 24ì‹œê°„ ìŠ¬ë¡¯ ìƒì„±
  for (let slotIndex = 0; slotIndex < 24; slotIndex++) {
    const displayHour = (6 + slotIndex) % 24;
    
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${displayHour.toString().padStart(2, '0')}:00`;
    timeSlot.style.gridRow = `${slotIndex + 2}`;
    timeSlot.style.gridColumn = '1';
    timeSlot.style.border = '1px solid #e0e0e0';
    timeSlot.style.padding = '8px';
    timeSlot.style.fontSize = '0.8em';
    timeSlot.style.textAlign = 'center';
    timeSlot.style.backgroundColor = '#fafafa';
    grid.appendChild(timeSlot);

    for (let day = 0; day < 7; day++) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      cell.dataset.day = day;
      cell.dataset.slot = slotIndex;
      cell.style.gridRow = `${slotIndex + 2}`;
      cell.style.gridColumn = `${day + 2}`;
      cell.style.border = '1px solid #e0e0e0';
      cell.style.position = 'relative';
      cell.style.backgroundColor = 'white';
      
      if (slotIndex >= 18) {
        cell.style.backgroundColor = '#f9f9f9';
      }
      
      dayCells[day][slotIndex] = cell;
      grid.appendChild(cell);
    }
  }

  // ì´ë²¤íŠ¸ ë Œë”ë§
  for (let day = 0; day < 7; day++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + day);

    const dayEvents = getAllEventsForDate(date);
    const eventCounts = Array(24).fill(0);
    
    dayEvents.forEach((event) => {
      if (event.time === 'ì¢…ì¼') {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'all-day-event';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.style.color = '#333';
        eventDiv.style.padding = '4px 8px';
        eventDiv.style.fontSize = '11px';
        eventDiv.style.borderRadius = '6px';
        eventDiv.style.margin = '2px';
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\nì‹œê°„: ${event.time}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
        
        dayCells[day][0].appendChild(eventDiv);
      } else {
        const startHour = getEventHour(event.startTime);
        const endHour = getEventHour(event.endTime);
        const startMinute = getEventMinute(event.startTime);
        const endMinute = getEventMinute(event.endTime);
        
        const startSlot = getSlotIndex(startHour);
        const endSlot = getSlotIndex(endHour);
        
        const currentEventIndex = eventCounts[startSlot];
        eventCounts[startSlot]++;
        
        const eventDiv = document.createElement('div');
        eventDiv.className = 'time-event';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.style.color = 'white';
        eventDiv.style.padding = '2px 6px';
        eventDiv.style.fontSize = '11px';
        eventDiv.style.position = 'absolute';
        eventDiv.style.boxSizing = 'border-box';
        eventDiv.style.zIndex = 100 + currentEventIndex;
        eventDiv.style.borderRadius = '6px';
        eventDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
        
        const cellHeight = 25;
        const topOffset = (startMinute / 60) * cellHeight;
        const duration = endSlot - startSlot + (endMinute - startMinute) / 60;
        const height = duration * cellHeight;
        
        eventDiv.style.top = `${topOffset}px`;
        eventDiv.style.height = `${Math.max(height, 20)}px`;
        
        const totalEvents = Math.max(eventCounts[startSlot], 1);
        const eventWidth = Math.floor(100 / totalEvents);
        const leftPosition = currentEventIndex * eventWidth;
        
        eventDiv.style.left = `${leftPosition}%`;
        eventDiv.style.width = `${eventWidth}%`;
        
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\nì‹œê°„: ${event.time}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
        
        if (dayCells[day][startSlot]) {
          dayCells[day][startSlot].appendChild(eventDiv);
        }
      }
    });
  }
  
  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

function renderDayView() {
  const container = document.createElement('div');
  container.style.padding = '20px';
  container.style.height = '600px';
  container.style.overflow = 'visible';

  const grid = document.createElement('div');
  grid.className = 'time-based-view day-view';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = `80px 1fr`;
  grid.style.gridTemplateRows = `35px repeat(24, 25px)`;
  grid.style.gap = '0';
  grid.style.height = '550px'; 

  // í—¤ë”ë“¤
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = 'ì‹œê°„';
  timeHeader.style.gridRow = '1';
  timeHeader.style.gridColumn = '1';
  timeHeader.style.border = '1px solid #e0e0e0';
  timeHeader.style.backgroundColor = '#f5f5f5';
  timeHeader.style.padding = '8px';
  timeHeader.style.textAlign = 'center';
  grid.appendChild(timeHeader);

  const dayHeader = document.createElement('div');
  dayHeader.className = 'week-header';
  const today = new Date();
  if (currentDate.toDateString() === today.toDateString()) {
    dayHeader.style.backgroundColor = accentColor;
  } else {
    dayHeader.style.backgroundColor = '#f5f5f5';
  }
  const options = { month: 'short', day: 'numeric', weekday: 'short' };
  const dayName = document.createElement('div');
  dayName.textContent = currentDate.toLocaleDateString('ko-KR', options);
  dayHeader.appendChild(dayName);
  dayHeader.style.gridRow = '1';
  dayHeader.style.gridColumn = '2';
  dayHeader.style.border = '1px solid #e0e0e0';
  dayHeader.style.padding = '8px';
  dayHeader.style.textAlign = 'center';
  grid.appendChild(dayHeader);

  // ì…€ ì €ì¥ìš© ë°°ì—´
  const dayCells = [];

  // 24ì‹œê°„ ìŠ¬ë¡¯
  for (let slotIndex = 0; slotIndex < 24; slotIndex++) {
    const displayHour = (6 + slotIndex) % 24;
    
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${displayHour.toString().padStart(2, '0')}:00`;
    timeSlot.style.gridRow = `${slotIndex + 2}`;
    timeSlot.style.gridColumn = '1';
    timeSlot.style.border = '1px solid #e0e0e0';
    timeSlot.style.padding = '8px';
    timeSlot.style.fontSize = '0.8em';
    timeSlot.style.textAlign = 'center';
    timeSlot.style.backgroundColor = '#fafafa';
    grid.appendChild(timeSlot);

    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.dataset.slot = slotIndex;
    cell.style.gridRow = `${slotIndex + 2}`;
    cell.style.gridColumn = '2';
    cell.style.border = '1px solid #e0e0e0';
    cell.style.position = 'relative';
    cell.style.backgroundColor = 'white';
    
    if (slotIndex >= 18) {
      cell.style.backgroundColor = '#f9f9f9';
    }
    
    dayCells[slotIndex] = cell;
    grid.appendChild(cell);
  }

  // ì´ë²¤íŠ¸ ì²˜ë¦¬
  const dayEvents = getAllEventsForDate(currentDate);
  const eventCounts = Array(24).fill(0);
  
  dayEvents.forEach((event) => {
    if (event.time === 'ì¢…ì¼') {
      const eventDiv = document.createElement('div');
      eventDiv.className = 'all-day-event';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.style.color = '#333';
      eventDiv.style.padding = '4px 8px';
      eventDiv.style.fontSize = '11px';
      eventDiv.style.borderRadius = '6px';
      eventDiv.style.margin = '2px';
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\nì‹œê°„: ${event.time}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
      
      dayCells[0].appendChild(eventDiv);
    } else {
      const startHour = getEventHour(event.startTime);
      const endHour = getEventHour(event.endTime);
      const startMinute = getEventMinute(event.startTime);
      const endMinute = getEventMinute(event.endTime);
      
      const startSlot = getSlotIndex(startHour);
      const endSlot = getSlotIndex(endHour);
      
      const currentEventIndex = eventCounts[startSlot];
      eventCounts[startSlot]++;
      
      const eventDiv = document.createElement('div');
      eventDiv.className = 'time-event';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.style.color = '#333';
      eventDiv.style.padding = '2px 6px';
      eventDiv.style.fontSize = '11px';
      eventDiv.style.position = 'absolute';
      eventDiv.style.boxSizing = 'border-box';
      eventDiv.style.zIndex = 100 + currentEventIndex;
      eventDiv.style.borderRadius = '6px';
      eventDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
      
      const cellHeight = 25;
      const topOffset = (startMinute / 60) * cellHeight;
      const duration = endSlot - startSlot + (endMinute - startMinute) / 60;
      const height = duration * cellHeight;
      
      eventDiv.style.top = `${topOffset}px`;
      eventDiv.style.height = `${Math.max(height, 20)}px`;
      
      const totalEvents = Math.max(eventCounts[startSlot], 1);
      const eventWidth = Math.floor(100 / totalEvents);
      const leftPosition = currentEventIndex * eventWidth;
      
      eventDiv.style.left = `${leftPosition}%`;
      eventDiv.style.width = `${eventWidth}%`;
      
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\nì‹œê°„: ${event.time}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
      
      if (dayCells[startSlot]) {
        dayCells[startSlot].appendChild(eventDiv);
      }
    }
  });

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// === í—¬í¼ í•¨ìˆ˜ë“¤ ===
function getAllEventsForDate(date) {
  const allEvents = [];
  const activeCalendarIds = viewCalendarSettings[currentView];

  calendars.forEach(calendar => {
    if (!calendar.visible || !calendar.events) return;

    if (activeCalendarIds.length > 0 && !activeCalendarIds.includes(calendar.id)) {
      return;
    }

    const events = calendar.events.filter(event => {
      return event.date === date.toISOString().split('T')[0];
    });
    events.forEach(event => {
      allEvents.push({
        ...event,
        color: calendar.color,
        calendarName: calendar.name
      });
    });
  });
  
  // ì¤‘ë³µ ì œê±°
  const uniqueEvents = [];
  const seenEvents = new Set();

  allEvents.forEach(event => {
      const key = `${event.title}_${event.date}_${event.startTime}_${event.endTime}`;
      if (!seenEvents.has(key)) {
          seenEvents.add(key);
          uniqueEvents.push(event);
      }
  });

  return uniqueEvents;
}

function getEventHour(timeString) {
  if (timeString === 'ì¢…ì¼') return 6;
  const parts = timeString.split(':');
  return parseInt(parts[0], 10) || 0;
}

function getEventMinute(timeString) {
  if (timeString === 'ì¢…ì¼') return 0;
  const parts = timeString.split(':');
  return parseInt(parts[1], 10) || 0;
}

function getSlotIndex(hour) {
  if (hour >= 6) {
    return hour - 6;  // 6-23ì‹œ: 0-17
  } else {
    return hour + 18;  // 0-5ì‹œ: 18-23
  }
}

// === ì´ˆê¸°í™” ===
function init() {
  loadFromStorage();
  updateCurrentDateDisplay();
  setAccentColor(accentColor);
  updateCalendarList();
  renderCalendar();
  addDebugLog('ìº˜ë¦°ë” ë·°ì–´ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
  
  // ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì • (2ë¶„ë§ˆë‹¤)
  setInterval(async () => {
    for (const calendar of calendars) {
      if (calendar.type !== 'sample' && calendar.visible) {
        try {
          const oldEventCount = calendar.events.length;
          await loadCalendarEvents(calendar);
          if (calendar.events.length !== oldEventCount) {
            renderCalendar();
            addDebugLog(`ìƒˆ ì¼ì • ê°ì§€: ${calendar.name}`);
          }
        } catch (error) {
          // ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬
        }
      }
    }
  }, 120000);
}

// === í•œêµ­ ê³µíœ´ì¼ ì¶”ê°€ ===
function addKoreanHolidays() {
  const holidayCalendar = {
    id: 'korean-holidays-' + Date.now(),
    name: 'í•œêµ­ ê³µíœ´ì¼',
    type: 'googlePublic',
    color: '#ea4335',
    visible: true,
    calendarId: 'ko.south_korea#holiday@group.v.calendar.google.com',
    events: [],
    status: 'loading',
    statusMessage: 'ë¡œë”© ì¤‘...'
  };
  
  calendars.push(holidayCalendar);
  updateCalendarList();
  
  loadCalendarEvents(holidayCalendar)
    .then(() => {
      updateCalendarStatus(holidayCalendar.id, 'success', `${holidayCalendar.events.length}ê°œ ì´ë²¤íŠ¸`);
      renderCalendar();
      saveToStorage();
      addDebugLog('í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ì¶”ê°€ ì™„ë£Œ');
    })
    .catch(error => {
      updateCalendarStatus(holidayCalendar.id, 'error', error.message);
      addDebugLog(`í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
    });
}

// === í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ===
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  
  switch(e.key) {
    case 'ArrowLeft':
      navigateCalendar(-1);
      e.preventDefault();
      break;
    case 'ArrowRight':
      navigateCalendar(1);
      e.preventDefault();
      break;
    case 't':
    case 'T':
      goToToday();
      break;
    case 'm':
    case 'M':
      setView('month');
      break;
    case 'w':
    case 'W':
      setView('week');
      break;
    case 'd':
    case 'D':
      setView('day');
      break;
    case 'Escape':
      closeSettings();
      break;
  }
});

// === ìº˜ë¦°ë” ìƒ‰ìƒ ìë™ í• ë‹¹ ===
const calendarColors = [
  '#4285f4', '#34a853', '#ea4335', '#ffc107', '#9c27b0', '#607d8b'
];

document.getElementById('calendarColor').addEventListener('focus', function() {
  this.value = calendarColors[calendars.length % calendarColors.length];
});

// === ë””ë²„ê·¸ ë„êµ¬ ===
window.debugCalendar = {
  showCalendars: () => console.table(calendars),
  showEvents: (calendarId) => {
    const calendar = calendars.find(c => c.id === calendarId || c.name === calendarId);
    if (calendar) {
      console.table(calendar.events);
    } else {
      console.log('ìº˜ë¦°ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  },
  clearStorage: () => {
    localStorage.removeItem('multiCalendarData');
    location.reload();
  },
  addKoreanHolidays: addKoreanHolidays
};

// === ì•± ì‹œì‘ ===
init();

// ë„ì›€ë§ í‘œì‹œ
console.log('%cë©€í‹° ìº˜ë¦°ë” ë·°ì–´ ë””ë²„ê·¸ ë„êµ¬%c\n' +
  'debugCalendar.showCalendars() - ëª¨ë“  ìº˜ë¦°ë” ì •ë³´ í‘œì‹œ\n' +
  'debugCalendar.showEvents(ìº˜ë¦°ë”ID) - íŠ¹ì • ìº˜ë¦°ë”ì˜ ì´ë²¤íŠ¸ í‘œì‹œ\n' +
  'debugCalendar.clearStorage() - ì €ì¥ëœ ë°ì´í„° ì‚­ì œ ë° ìƒˆë¡œê³ ì¹¨\n' +
  'debugCalendar.addKoreanHolidays() - í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ì¶”ê°€', 
  'color: #D1D1D1; font-weight: bold; font-size: 14px;', 
  'color: #333; font-size: 12px;');
</script>
</body>
</html>
