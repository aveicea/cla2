// <!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë©€í‹° ìº˜ë¦°ë” ë·°ì–´</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #ffffff;
    min-height: 100vh;
    height: 100vh;
    display: flex;
    flex-direction: column;
    max-width: 1000px;
    margin: 0 auto;
  }
  
  .header {
    padding: 10px 20px;
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    flex-shrink: 0;
  }
  
  .view-selector {
    display: flex;
    gap: 8px;
    align-items: center;
    flex: 1;
    justify-content: center;
  }
  
  .view-btn {
    padding: 6px 10px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #666;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  
  .view-btn.active {
    background: var(--accent-color, #4285f4);
    color: white;
    border-color: var(--accent-color, #4285f4);
  }
  
  .nav-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-right: 20px;
  }
  
  .nav-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    color: #666;  
  }
  
  .nav-btn:hover {
    background: #f8f9fa;
    color: #333;
  }
  
  .current-date {
    padding: 6px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    color: #333;
    min-width: 100px;
    text-align: center;
    margin: 0 5px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .settings-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    transition: all 0.2s ease;
  }
  
  .settings-btn:hover {
    background: #e8eaed;
    color: #333;
  }
  
  .settings-panel {
    position: absolute;
    top: 45px;
    right: 20px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: 450px;
    z-index: 1000;
    display: none;
    max-height: 70vh;
    overflow-y: auto;
    max-width: calc(100vw - 40px);
    box-sizing: border-box;
  }
  
  .settings-title {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 15px;
    color: #333;
  }
  
  .color-picker-group {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .color-picker-title {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 10px;
    color: #333;
  }
  
  .color-input-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .color-picker-input {
    width: 40px;
    height: 30px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    padding: 0;
  }
  
  .color-text-input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
  }
  
  .preset-colors {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
  }
  
  .preset-color {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .preset-color:hover {
    transform: scale(1.1);
    border-color: #333;
  }
  
  .calendar-list-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .calendar-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 8px;
    background: #f8f9fa;
  }
  
  .calendar-item.active {
    border-color: var(--accent-color, #4285f4);
    background: #e3f2fd;
  }
  
  .calendar-color-picker {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 50%;
    margin-right: 8px;
    cursor: pointer;
    padding: 0;
    background: none;
    box-shadow: 0 0 0 2px white, 0 0 0 3px #ddd;
  }
  
  .calendar-color-picker:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease;
  }
  
  .calendar-info {
    flex: 1;
  }
  
  .calendar-name {
    font-size: 13px;
    font-weight: 500;
    color: #333;
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }
  
  .calendar-name:focus {
    outline: 1px solid var(--accent-color, #4285f4);
    outline-offset: 1px;
    border-radius: 2px;
  }
  
  .calendar-url {
    font-size: 11px;
    color: #666;
    word-break: break-all;
    margin-top: 2px;
  }
  
  .calendar-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    margin-top: 2px;
    display: inline-block;
  }
  
  .calendar-status.success {
    background: #e8f5e8;
    color: #2e7d32;
  }
  
  .calendar-status.error {
    background: #ffebee;
    color: #c62828;
  }
  
  .calendar-status.loading {
    background: #e3f2fd;
    color: #1976d2;
  }
  
  .calendar-actions {
    display: flex;
    gap: 4px;
  }
  
  .toggle-btn {
    width: 20px;
    height: 20px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s ease;
  }
  
  .toggle-btn.visible {
    background: var(--accent-color, #4285f4);
    color: white;
  }
  
  .toggle-btn.hidden {
    background: #ccc;
    color: white;
  }
  
  .remove-btn {
    background: #f44336;
    color: white;
  }
  
  .reload-btn {
    background: #ff9800;
    color: white;
    font-size: 10px;
  }
  
  .add-calendar-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .input-group {
    margin-bottom: 10px;
  }
  
  .input-group label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }
  
  .input-group input, .input-group textarea, .input-group select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    box-sizing: border-box;
    resize: vertical;
  }
  
  .help-text {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
    line-height: 1.4;
  }
  
  .btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 8px;
    margin-bottom: 8px;
  }
  
  .btn-primary {
    background: var(--accent-color, #4285f4);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--accent-hover-color, #3367d6);
  }
  
  .btn-secondary {
    background: #f8f9fa;
    color: #666;
    border: 1px solid #ddd;
  }
  
  .calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .calendar-content {
    flex: 1;
    overflow: auto;
    background: #f8f9fa;
    height: calc(100vh - 120px);
    min-height: 400px;
  }
    
  /* ì›”ê°„ ë·° */
  .calendar-grid.month-view {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: auto repeat(6, 1fr);
    gap: 1px;
    background: #e0e0e0;
    border: 1px solid #e0e0e0;
    height: calc(100vh - 150px);
    min-height: 250px;
    max-height: 400px;
    width: 100%;
  }
  
  .calendar-day {
    background: white;
    min-height: 40px;
    max-height: 120px;
    padding: 4px;
    position: relative;
    font-size: 11px;
    border: none;
    overflow-y: auto;
    overflow-x: hidden;
    width: 100%;
    box-sizing: border-box;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .calendar-day::-webkit-scrollbar {
    display: none;
  }
  
  .calendar-day.other-month {
    background: #f8f9fa;
    color: #999;
  }
  
  .calendar-day.today {
    background: var(--accent-color, #4285f4);
    color: white;
  }
  
  .day-number {
    font-weight: 500;
    margin-bottom: 3px;
  }
  
  .event {
    padding: 1px 3px;
    border-radius: 2px;
    font-size: 10px;
    margin-bottom: 1px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #333;
    cursor: pointer;
    max-width: 100%;
    display: block;
  }
  
  /* ì‹œê°„ ê¸°ë°˜ ë·° */
  .time-based-view {
    display: grid;
    background: white;
    min-height: 600px;
    overflow: visible;
  }
  
  .week-view {
    grid-template-columns: 50px repeat(7, 1fr);
    grid-template-rows: 30px repeat(24, 25px);
  }
  
  .day-view {
    grid-template-columns: 50px 1fr;
    grid-template-rows: 30px repeat(24, 25px);
  }
  
  .time-slot {
    background: #f8f9fa;
    padding: 2px;
    font-size: 8px;
    color: #666;
    border-right: 1px solid #e0e0e0;
    border-bottom: 1px solid #f0f0f0;
    text-align: center;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .day-column {
    background: white;
    position: relative;
    border-right: 1px solid #f0f0f0;
    border-bottom: 1px solid #f0f0f0;
    overflow: hidden;
  }
  
  .day-column:last-child {
    border-right: none;
  }
  
  .week-header {
    background: #f8f9fa;
    padding: 8px;
    font-weight: 500;
    text-align: center;
    font-size: 11px;
    border-bottom: 1px solid #e0e0e0;
    border-right: 1px solid #f0f0f0;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  
  .week-header:last-child {
    border-right: none;
  }
  
  .week-header.today {
    background: var(--accent-color, #4285f4);
    color: white;
    font-weight: 600;
  }
  
  .week-header small {
    font-size: 11px;
    font-weight: normal;
    margin-top: 2px;
  }
  
  .time-event {
    position: absolute;
    left: 4px;
    right: 4px;
    border-radius: 4px;
    padding: 2px 6px;
    color: white;
    font-weight: 500;
    font-size: 6px;
    overflow: visible;
    text-overflow: clip;
    white-space: normal;
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.2;
    min-height: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  
  .time-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 2;
  }
  
  .all-day-event {
    position: absolute;
    top: 2px;
    left: 4px;
    right: 4px;
    height: 20px;
    line-height: 18px;
    border-radius: 3px;
    padding: 0 6px;
    color: #333;
    font-weight: 500;
    font-size: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    z-index: 1;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #666;
  }
  
  .error-message {
    background: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 8px;
    padding: 16px;
    margin: 20px;
    color: #c62828;
    font-size: 12px;
  }
  
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.1);
    z-index: 999;
    display: none;
  }
  
  .debug-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .debug-log {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 10px;
    font-family: monospace;
    font-size: 11px;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
  }
  
  .calendar-inputs {
    display: none;
  }
  
  .calendar-inputs.active {
    display: block;
  }
  
  .toggle-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
  }

  .toggle-header:hover {
    background: rgba(0,0,0,0.02);
    border-radius: 4px;
  }

  .toggle-icon {
    font-size: 12px;
    transition: transform 0.2s;
    color: #666;
    margin-left: 8px;
  }

  .toggle-icon.expanded {
    transform: rotate(180deg);
  }

  .toggle-content {
    display: none;
    margin-top: 8px;
  }

  .toggle-content.expanded {
    display: block;
  }

  .view-calendar-section {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
  }

  .view-calendar-section:last-child {
    border-bottom: none;
  }

  .view-calendar-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .view-calendar-item {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
  }

  .view-calendar-item:hover {
    background-color: #f0f0f0;
  }

  .view-calendar-item input[type="checkbox"] {
    cursor: pointer;
  }
  
  @media (max-width: 768px) {
    .settings-panel {
      right: 10px;
      left: 10px;
      width: auto;
      max-width: none;
    }
    .nav-controls {
      margin-right: 10px;
    }
  }
</style>
</head>
<body>
<div class="header">
  <div class="view-selector">
    <button class="view-btn active" onclick="setView('day')" id="dayBtn">ì¼</button>
    <button class="view-btn" onclick="setView('week')" id="weekBtn">ì£¼</button>
    <button class="view-btn" onclick="setView('month')" id="monthBtn">ì›”</button>
  </div>
  
  <div class="nav-controls">
    <button class="nav-btn" onclick="navigateCalendar(-1)">â€¹</button>
    <div class="current-date" id="currentDate"></div>
    <button class="nav-btn" onclick="navigateCalendar(1)">â€º</button>
    <button class="nav-btn" onclick="goToToday()">ğŸ“…</button>
  </div>
  
  <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
  
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-title">ë©€í‹° ìº˜ë¦°ë” ì„¤ì •</div>

    <!-- ë·°ë³„ ìº˜ë¦°ë” ì„ íƒ -->
    <div class="view-calendar-section">
      <div class="toggle-header" onclick="toggleSection('viewCalendarSettings', 'viewToggleIcon')">
        <div class="color-picker-title">ë·°ë³„ ìº˜ë¦°ë” ì„ íƒ</div>
        <div class="toggle-icon" id="viewToggleIcon">â–¼</div>
      </div>
      <div class="toggle-content" id="viewCalendarSettings">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
    </div>

    <!-- í…Œë§ˆ ìƒ‰ìƒ -->
    <div class="color-picker-group">
      <div class="toggle-header" onclick="toggleSection('themeColorContent', 'themeToggleIcon')">
        <div class="color-picker-title">í…Œë§ˆ ìƒ‰ìƒ</div>
        <div class="toggle-icon" id="themeToggleIcon">â–¼</div>
      </div>
      <div class="toggle-content" id="themeColorContent">
        <div class="color-input-row">
          <input type="color" class="color-picker-input" id="colorPicker" onchange="updateColorFromPicker()">
          <input type="text" class="color-text-input" id="colorText" placeholder="#4285f4" oninput="updateColorFromText()" maxlength="7">
        </div>
        <div class="preset-colors">
          <div class="preset-color" style="background-color: #4285f4;" onclick="setPresetColor('#4285f4')"></div>
          <div class="preset-color" style="background-color: #34a853;" onclick="setPresetColor('#34a853')"></div>
          <div class="preset-color" style="background-color: #ea4335;" onclick="setPresetColor('#ea4335')"></div>
          <div class="preset-color" style="background-color: #ffc107;" onclick="setPresetColor('#ffc107')"></div>
          <div class="preset-color" style="background-color: #9c27b0;" onclick="setPresetColor('#9c27b0')"></div>
          <div class="preset-color" style="background-color: #607d8b;" onclick="setPresetColor('#607d8b')"></div>
        </div>
      </div>
    </div>

    <!-- ì—°ë™ëœ ìº˜ë¦°ë” ëª©ë¡ -->
    <div class="calendar-list-section">
      <div class="toggle-header" onclick="toggleSection('calendarListContent', 'listToggleIcon')">
        <div class="color-picker-title">ì—°ë™ëœ ìº˜ë¦°ë” ëª©ë¡</div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <button class="nav-btn" onclick="refreshAllCalendars()" title="ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
          <div class="toggle-icon" id="listToggleIcon">â–¼</div>
        </div>
      </div>
      <div class="toggle-content" id="calendarListContent">
        <div id="calendarList">
          <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
            ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì—ì„œ ìº˜ë¦°ë”ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!
          </p>
        </div>
      </div>
    </div>

    <!-- ìº˜ë¦°ë” ì¶”ê°€ -->
    <div class="add-calendar-section">
      <div class="toggle-header" onclick="toggleSection('addCalendarContent', 'addToggleIcon')">
        <div class="color-picker-title">ìº˜ë¦°ë” ì¶”ê°€</div>
        <div class="toggle-icon" id="addToggleIcon">â–¼</div>
      </div>
      <div class="toggle-content" id="addCalendarContent">
        <div class="input-group">
          <label>ìº˜ë¦°ë” ìœ í˜•</label>
          <select id="calendarType" onchange="updateCalendarInputs()">
            <option value="ical">iCal ë§í¬ (.ics)</option>
            <option value="googlePublic">êµ¬ê¸€ ìº˜ë¦°ë” ê³µê°œ ë§í¬</option>
            <option value="api">êµ¬ê¸€ ìº˜ë¦°ë” API</option>
          </select>
        </div>
        
        <div class="input-group">
          <label>ìº˜ë¦°ë” ì´ë¦„</label>
          <input type="text" id="calendarName" placeholder="ì˜ˆ: ê°œì¸ ì¼ì •, ì—…ë¬´ ìº˜ë¦°ë”">
        </div>
        
        <div class="input-group">
          <label>ìº˜ë¦°ë” ìƒ‰ìƒ</label>
          <input type="color" id="calendarColor" value="#4285f4">
        </div>
        
        <div id="icalInputs" class="calendar-inputs active">
          <div class="input-group">
            <label>iCal ë§í¬</label>
            <textarea id="icalUrl" rows="3" placeholder="https://calendar.google.com/calendar/ical/.../basic.ics"></textarea>
            <div class="help-text">
              êµ¬ê¸€ ìº˜ë¦°ë” ì„¤ì • â†’ í†µí•© ë° ê³µìœ  â†’ ë¹„ê³µê°œ ì£¼ì†Œì˜ iCal ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.
            </div>
          </div>
        </div>
        
        <div id="googlePublicInputs" class="calendar-inputs">
          <div class="input-group">
            <label>êµ¬ê¸€ ìº˜ë¦°ë” ID</label>
            <input type="text" id="googleCalendarId" placeholder="ìº˜ë¦°ë”ID@group.calendar.google.com">
            <div class="help-text">
              ê³µê°œëœ êµ¬ê¸€ ìº˜ë¦°ë”ì˜ ìº˜ë¦°ë” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
              ì˜ˆ: ko.south_korea#holiday@group.v.calendar.google.com (í•œêµ­ ê³µíœ´ì¼)
            </div>
          </div>
        </div>
        
        <div id="apiInputs" class="calendar-inputs">
          <div class="input-group">
            <label>API í‚¤</label>
            <input type="text" id="apiKey" placeholder="Google Calendar API í‚¤">
          </div>
          <div class="input-group">
            <label>ìº˜ë¦°ë” ID</label>
            <input type="text" id="calendarId" placeholder="primary ë˜ëŠ” ì´ë©”ì¼@gmail.com">
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="addCalendar()">ìº˜ë¦°ë” ì¶”ê°€</button>
        <button class="btn btn-secondary" onclick="addSampleCalendar()">ìƒ˜í”Œ ìº˜ë¦°ë” ì¶”ê°€</button>
        <button class="btn btn-secondary" onclick="addKoreanHolidays()">í•œêµ­ ê³µíœ´ì¼ ì¶”ê°€</button>
      </div>
    </div>

    <div class="backup-section">
      <div class="toggle-header" onclick="toggleSection('backupContent', 'backupToggleIcon')">
        <div class="color-picker-title">ì„¤ì • ë°±ì—…/ë³µì›</div>
        <div class="toggle-icon" id="backupToggleIcon">â–¼</div>
      </div>
      <div class="toggle-content" id="backupContent">
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
          <button class="btn btn-primary" onclick="exportCalendarSettings()">ì„¤ì • ë‚´ë ¤ë°›ê¸°</button>
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ì„¤ì • ê°€ì ¸ì˜¤ê¸°</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importCalendarSettings(this)">
        <div style="font-size: 11px; color: #666; margin-top: 5px;">
          ìº˜ë¦°ë” ì—°ë™ ì •ë³´, ìƒ‰ìƒ, ë·° ì„¤ì • ë“±ì„ ë°±ì—…í•˜ê³  ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>
    
    <div class="debug-section">
      <div class="toggle-header" onclick="toggleSection('debugContent', 'debugToggleIcon')">
        <div class="color-picker-title">ë””ë²„ê·¸ ì •ë³´</div>
        <div class="toggle-icon" id="debugToggleIcon">â–¼</div>
      </div>
      <div class="toggle-content" id="debugContent">
        <button class="btn btn-secondary" onclick="clearDebugLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        <div id="debugLog" class="debug-log"></div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSettings()"></div>

<div class="calendar-container">
  <div class="calendar-item ${calendar.visible ? 'active' : ''}" data-id="${calendar.id}">
    <input type="color" value="${calendar.color}" 
           onchange="updateCalendarColor('${calendar.id}', this.value)" 
           class="calendar-color-picker" 
           title="ìº˜ë¦°ë” ìƒ‰ìƒ ë³€ê²½">
    <div class="calendar-info">
      <input class="calendar-name" value="${calendar.name}" 
             onchange="updateCalendarName('${calendar.id}', this.value)"
             onblur="updateCalendarName('${calendar.id}', this.value)">
      <div class="calendar-url">${calendar.type === 'sample' ? 'ìƒ˜í”Œ ë°ì´í„°' : 
        (calendar.url || calendar.calendarId || '').substring(0, 30)}${(calendar.url || calendar.calendarId || '').length > 30 ? '...' : ''}</div>
      <div class="calendar-status ${calendar.status}">${calendar.statusMessage || calendar.status}</div>
    </div>
    <div class="calendar-actions">
      <button class="toggle-btn ${calendar.visible ? 'visible' : 'hidden'}" 
              onclick="toggleCalendarVisibility('${calendar.id}')" 
              title="${calendar.visible ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ì´ê¸°'}">
        ${calendar.visible ? 'ğŸ‘ï¸' : 'ğŸš«'}
      </button>
      <button class="toggle-btn reload-btn" onclick="reloadCalendar('${calendar.id}')" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
      <button class="toggle-btn remove-btn" onclick="removeCalendar('${calendar.id}')" title="ì‚­ì œ">âœ•</button>
    </div>
  </div>
  
  <script>
    // === 6ì‹œ ê¸°ì¤€ ë‚ ì§œ ì‹œìŠ¤í…œ ===
    // í•µì‹¬ ê°œë…: ì˜¤ì „ 6ì‹œë¥¼ í•˜ë£¨ì˜ ì‹œì‘ìœ¼ë¡œ ê°„ì£¼
    // ìƒˆë²½ 0-6ì‹œëŠ” "ì „ë‚ ì˜ ì—°ì¥"ìœ¼ë¡œ ì²˜ë¦¬
    
    // 6ì‹œ ê¸°ì¤€ íš¨ê³¼ì  ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
    function getEffectiveToday() {
      const now = new Date();
      if (now.getHours() < 6) {
        const effectiveDate = new Date(now);
        effectiveDate.setDate(now.getDate() - 1);
        return effectiveDate;
      }
      return now;
    }
    
    // 6ì‹œ ê¸°ì¤€ìœ¼ë¡œ íŠ¹ì • ë‚ ì§œê°€ "ì˜¤ëŠ˜"ì¸ì§€ í™•ì¸
    function isEffectiveToday(date) {
      const effectiveToday = getEffectiveToday();
      return date.toDateString() === effectiveToday.toDateString();
    }
    
    // íŠ¹ì • ë‚ ì§œì˜ ì´ë²¤íŠ¸ë¥¼ 6ì‹œ ê¸°ì¤€ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
    function getEventsForEffectiveDate(targetDate) {
      const allEvents = [];
      const targetDateStr = targetDate.toISOString().split('T')[0];
      const seenEvents = new Map(); // ì¤‘ë³µ ì²´í¬ìš©
      
      // í™œì„±í™”ëœ ìº˜ë¦°ë” í•„í„°ë§
      const activeCalendarIds = viewCalendarSettings[currentView];
      
      calendars.forEach(calendar => {
        if (!calendar.visible || !calendar.events) return;
        if (activeCalendarIds.length > 0 && !activeCalendarIds.includes(calendar.id)) return;
        
        calendar.events.forEach(event => {
          // 6ì‹œ ê¸°ì¤€ìœ¼ë¡œ ì´ ì´ë²¤íŠ¸ê°€ ì–´ëŠ ë‚ ì— ì†í•˜ëŠ”ì§€ ê³„ì‚°
          let eventEffectiveDate = event.date;
          
          // ìƒˆë²½ 0-6ì‹œ ì´ë²¤íŠ¸ëŠ” ì „ë‚ ì— ì†í•¨
          if (event.startTime && event.startTime !== 'ì¢…ì¼') {
            const startHour = parseInt(event.startTime.split(':')[0]);
            if (startHour < 6) {
              const eventDate = new Date(event.date + 'T12:00:00');
              eventDate.setDate(eventDate.getDate() - 1);
              eventEffectiveDate = eventDate.toISOString().split('T')[0];
            }
          }
          
          // íƒ€ê²Ÿ ë‚ ì§œì™€ ë§¤ì¹­ë˜ëŠ” ì´ë²¤íŠ¸ë§Œ ì¶”ê°€
          if (eventEffectiveDate === targetDateStr) {
            const eventKey = event.recurringId || `${event.uid || event.id}_${event.date}_${event.startTime}`;
            
            if (!seenEvents.has(eventKey)) {
              seenEvents.set(eventKey, true);
              allEvents.push({
                ...event,
                color: calendar.color,
                calendarName: calendar.name
              });
            } else if (event.isModified) {
              // ìˆ˜ì •ëœ ë²„ì „ì´ë©´ êµì²´
              const index = allEvents.findIndex(e => 
                (e.recurringId === eventKey) || 
                (`${e.uid || e.id}_${e.date}_${e.startTime}` === eventKey)
              );
              if (index >= 0) {
                allEvents[index] = {
                  ...event,
                  color: calendar.color,
                  calendarName: calendar.name
                };
              }
            }
          }
        });
      });
      
      return allEvents;
    }
    
    // ì „ì—­ ë³€ìˆ˜
    let currentView = 'day';
    let currentDate = getEffectiveToday(); // 6ì‹œ ê¸°ì¤€ í˜„ì¬ ë‚ ì§œ
    let accentColor = '#4285f4';
    let accentHoverColor = '#3367d6';
    let calendars = [];
    let debugMessages = [];
    
    let viewCalendarSettings = {
      day: [],    // ì¼ê°„ë·°ì—ì„œ ë³´ì¼ ìº˜ë¦°ë” ID ë°°ì—´
      week: [],   // ì£¼ê°„ë·°ì—ì„œ ë³´ì¼ ìº˜ë¦°ë” ID ë°°ì—´  
      month: []   // ì›”ê°„ë·°ì—ì„œ ë³´ì¼ ìº˜ë¦°ë” ID ë°°ì—´
    };
    
    // ìº˜ë¦°ë” ìƒ‰ìƒ íŒ”ë ˆíŠ¸
    const calendarColors = [
      '#4285f4', '#34a853', '#ea4335', '#ffc107', '#9c27b0', '#607d8b'
    ];
    
    // DOM ìš”ì†Œ
    const settingsPanel = document.getElementById("settingsPanel");
    const overlay = document.getElementById("overlay");
    const colorPicker = document.getElementById("colorPicker");
    const colorText = document.getElementById("colorText");
    const currentDateElement = document.getElementById("currentDate");
    const calendarContent = document.getElementById("calendarContent");
    const calendarList = document.getElementById("calendarList");
    const debugLog = document.getElementById("debugLog");
    
    // ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜
    function addDebugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugMessages.push(`[${timestamp}] ${message}`);
      if (debugMessages.length > 50) debugMessages.shift();
      
      if (debugLog) {
        debugLog.innerHTML = debugMessages.map(msg => `<div>${msg}</div>`).join('');
        debugLog.scrollTop = debugLog.scrollHeight;
      }
      console.log(message);
    }
    
    function clearDebugLog() {
      debugMessages = [];
      if (debugLog) {
        debugLog.innerHTML = '';
      }
    }
    
    // ì´ˆê¸°í™”
    function init() {
      loadFromStorage();
      
      // í•­ìƒ 6ì‹œ ê¸°ì¤€ ì˜¤ëŠ˜ë¡œ ì‹œì‘
      currentDate = getEffectiveToday();
      
      updateCurrentDateDisplay();
      setAccentColor(accentColor);
      updateCalendarList();
      renderCalendar();
      addDebugLog('6ì‹œ ê¸°ì¤€ ìº˜ë¦°ë” ë·°ì–´ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
      
      // ìë™ ìƒˆë¡œê³ ì¹¨ (2ë¶„ë§ˆë‹¤)
      setInterval(async () => {
        for (const calendar of calendars) {
          if (calendar.type !== 'sample' && calendar.visible) {
            try {
              const oldEventCount = calendar.events.length;
              await loadCalendarEvents(calendar);
              if (calendar.events.length !== oldEventCount) {
                renderCalendar();
                addDebugLog(`ìƒˆ ì¼ì • ê°ì§€: ${calendar.name}`);
              }
            } catch (error) {
              // ì¡°ìš©íˆ ì‹¤íŒ¨ ì²˜ë¦¬
            }
          }
        }
      }, 120000);
    }
    
    // ì„¤ì • íŒ¨ë„
    function toggleSettings() {
      const isVisible = settingsPanel.style.display === 'block';
      if (isVisible) {
        closeSettings();
      } else {
        openSettings();
      }
    }
    
    function openSettings() {
      settingsPanel.style.display = 'block';
      overlay.style.display = 'block';
    }
    
    function closeSettings() {
      settingsPanel.style.display = 'none';
      overlay.style.display = 'none';
    }
    
    // ë·° ë³€ê²½
    function setView(viewMode) {
      currentView = viewMode;
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(viewMode + 'Btn').classList.add('active');
      updateCurrentDateDisplay();
      renderCalendar();
      saveToStorage();
    }
    
    // ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜
    function navigateCalendar(direction) {
      if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + direction);
      } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + (direction * 7));
      } else if (currentView === 'day') {
        currentDate.setDate(currentDate.getDate() + direction);
      }
      updateCurrentDateDisplay();
      renderCalendar();
      saveToStorage();
    }
    
    function goToToday() {
      currentDate = getEffectiveToday();
      updateCurrentDateDisplay();
      renderCalendar();
    }
    
    function updateCurrentDateDisplay() {
      const options = currentView === 'day' 
        ? { month: 'long', day: 'numeric', weekday: 'short' }
        : { year: 'numeric', month: 'long' };
      
      currentDateElement.textContent = currentDate.toLocaleDateString('ko-KR', options);
    }
    
    // ìƒ‰ìƒ ê´€ë¦¬
    function darkenColor(hex, percent) {
      const num = parseInt(hex.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }
    
    function setAccentColor(color) {
      accentColor = color;
      accentHoverColor = darkenColor(color, 15);
      
      document.documentElement.style.setProperty('--accent-color', color);
      document.documentElement.style.setProperty('--accent-hover-color', accentHoverColor);
      
      if (colorPicker) colorPicker.value = color;
      if (colorText) colorText.value = color.toUpperCase();
      
      saveToStorage();
    }
    
    function setPresetColor(color) {
      setAccentColor(color);
    }
    
    function updateColorFromPicker() {
      setAccentColor(colorPicker.value);
    }
    
    function updateColorFromText() {
      let color = colorText.value.trim();
      if (!color.startsWith('#')) color = '#' + color;
      if (/^#[0-9A-F]{6}$/i.test(color)) {
        setAccentColor(color);
      }
    }
    
    // ìº˜ë¦°ë” ì…ë ¥ í¼ ì—…ë°ì´íŠ¸
    function updateCalendarInputs() {
      const type = document.getElementById('calendarType').value;
      
      document.querySelectorAll('.calendar-inputs').forEach(input => {
        input.classList.remove('active');
      });
      
      document.getElementById(type + 'Inputs').classList.add('active');
    }
    
    // ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë¡œë“œ
    async function loadCalendarEvents(calendar) {
      addDebugLog(`ì´ë²¤íŠ¸ ë¡œë“œ ì‹œì‘: ${calendar.name} (${calendar.type})`);
      
      if (calendar.type === 'ical') {
        await loadIcalEvents(calendar);
      } else if (calendar.type === 'googlePublic') {
        await loadGooglePublicEvents(calendar);
      } else if (calendar.type === 'api') {
        await loadApiEvents(calendar);
      }
    }
    
    // iCal ì´ë²¤íŠ¸ ë¡œë“œ
    async function loadIcalEvents(calendar) {
      const proxies = [
        `https://corsproxy.io/?${encodeURIComponent(calendar.url)}`,
        `https://proxy.cors.sh/${calendar.url}`,
        `https://cors.sh/${calendar.url}`,
        `https://thingproxy.freeboard.io/fetch/${calendar.url}`,
        `https://yacdn.org/proxy/${calendar.url}`
      ];
      
      let lastError = null;
      
      for (const proxyUrl of proxies) {
        try {
          addDebugLog(`í”„ë¡ì‹œ ì‹œë„: ${proxyUrl.split('/')[2]}`);
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);
          
          const response = await fetch(proxyUrl, {
            method: 'GET',
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'text/calendar,text/plain,*/*',
              'Cache-Control': 'no-cache'
            },
            signal: controller.signal,
            mode: 'cors'
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          let icalData;
          if (proxyUrl.includes('allorigins')) {
            const data = await response.json();
            icalData = data.contents;
          } else {
            icalData = await response.text();
          }
          
          if (!icalData || typeof icalData !== 'string') {
            throw new Error('ì‘ë‹µì´ í…ìŠ¤íŠ¸ê°€ ì•„ë‹˜');
          }
          
          if (!icalData.includes('BEGIN:VCALENDAR') && !icalData.includes('BEGIN:VEVENT')) {
            throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ iCal ë°ì´í„°');
          }
          
          calendar.events = parseIcalData(icalData);
          addDebugLog(`iCal íŒŒì‹± ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
          return;
          
        } catch (error) {
          lastError = error;
          if (error.name === 'AbortError') {
            addDebugLog(`í”„ë¡ì‹œ íƒ€ì„ì•„ì›ƒ: ${proxyUrl.split('/')[2]}`);
          } else {
            addDebugLog(`í”„ë¡ì‹œ ì‹¤íŒ¨: ${proxyUrl.split('/')[2]} - ${error.message}`);
          }
          continue;
        }
      }
      
      throw new Error(`ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨. ë§ˆì§€ë§‰ ì˜¤ë¥˜: ${lastError.message}\n\ní•´ê²°ë°©ë²•:\n1. êµ¬ê¸€ ìº˜ë¦°ë” ê³µê°œ ì„¤ì • í™•ì¸\n2. iCal ë§í¬ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n3. ë‹¤ë¥¸ ìº˜ë¦°ë” ì„œë¹„ìŠ¤ ì´ìš© ê³ ë ¤`);
    }
    
    // êµ¬ê¸€ ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ
    async function loadGooglePublicEvents(calendar) {
      const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
      const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
      
      const apiKey = 'AIzaSyBNlYH01_9Hc5S1J9vuFmu2nUqBZJNAXxs';
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
      
      try {
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`API ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.items) {
          throw new Error('ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        }
        
        calendar.events = data.items.map(event => {
          const startDate = event.start.dateTime || event.start.date;
          const endDate = event.end.dateTime || event.end.date;
          const startTime = new Date(startDate);
          const endTime = new Date(endDate);
          
          return {
            title: event.summary || 'ì œëª© ì—†ìŒ',
            date: startTime.toISOString().split('T')[0],
            startTime: event.start.dateTime ? 
              startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
              'ì¢…ì¼',
            endTime: event.end.dateTime ? 
              endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
              'ì¢…ì¼',
            description: event.description || '',
            location: event.location || ''
          };
        });
        
        addDebugLog(`êµ¬ê¸€ ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
        
      } catch (error) {
        addDebugLog(`êµ¬ê¸€ ê³µê°œ ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        throw error;
      }
    }
    
    // API ì´ë²¤íŠ¸ ë¡œë“œ
    async function loadApiEvents(calendar) {
      const timeMin = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString();
      const timeMax = new Date(currentDate.getFullYear(), currentDate.getMonth() + 2, 0).toISOString();
      
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.calendarId)}/events?key=${calendar.apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&orderBy=startTime&singleEvents=true`;
      
      try {
        const response = await fetch(url);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(`API ì˜¤ë¥˜ ${response.status}: ${errorData.error?.message || response.statusText}`);
        }
        
        const data = await response.json();
        
        calendar.events = data.items.map(event => {
          const startDate = event.start.dateTime || event.start.date;
          const endDate = event.end.dateTime || event.end.date;
          const startTime = new Date(startDate);
          const endTime = new Date(endDate);
          
          return {
            title: event.summary || 'ì œëª© ì—†ìŒ',
            date: startTime.toISOString().split('T')[0],
            startTime: event.start.dateTime ? 
              startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
              'ì¢…ì¼',
            endTime: event.end.dateTime ? 
              endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }) :
              'ì¢…ì¼',
            description: event.description || '',
            location: event.location || ''
          };
        });
        
        addDebugLog(`API ìº˜ë¦°ë” ë¡œë“œ ì™„ë£Œ: ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
        
      } catch (error) {
        addDebugLog(`API ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        throw error;
      }
    }
    
    // iCal ë°ì´í„° íŒŒì‹± (ì™„ì „í•œ ë°˜ë³µ ì¼ì • ì§€ì›)
    function parseIcalData(icalText) {
      const events = [];
      const lines = icalText.split(/\r?\n/);
      let currentEvent = null;
      const exceptionEvents = new Map();
      const recurringEvents = [];
      
      addDebugLog(`iCal íŒŒì‹± ì‹œì‘: ${lines.length}ì¤„`);
      
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        
        // ë©€í‹°ë¼ì¸ ì²˜ë¦¬
        while (i + 1 < lines.length && lines[i + 1].match(/^\s/)) {
          i++;
          line += lines[i].trim();
        }
        
        if (line === 'BEGIN:VEVENT') {
          currentEvent = {};
        } 
        else if (line === 'END:VEVENT' && currentEvent) {
          if (currentEvent.summary && currentEvent.dtstart) {
            const baseEvent = {
              id: currentEvent.uid || `event_${Date.now()}_${Math.random()}`,
              uid: currentEvent.uid,
              title: currentEvent.summary,
              date: currentEvent.date,
              startTime: currentEvent.startTime || 'ì¢…ì¼',
              endTime: currentEvent.endTime || 'ì¢…ì¼',
              description: currentEvent.description || '',
              location: currentEvent.location || '',
              rrule: currentEvent.rrule,
              exdate: currentEvent.exdate || [],
              recurrenceId: currentEvent.recurrenceId,
              isException: currentEvent.isException
            };
            
            // ìˆ˜ì •ëœ ì¸ìŠ¤í„´ìŠ¤ì¸ ê²½ìš°
            if (currentEvent.recurrenceId && currentEvent.uid) {
              const exceptionKey = `${currentEvent.uid}_${currentEvent.recurrenceId}`;
              exceptionEvents.set(exceptionKey, baseEvent);
              addDebugLog(`ì˜ˆì™¸ ì´ë²¤íŠ¸ ì €ì¥: ${exceptionKey}`);
            }
            // ë°˜ë³µ ì¼ì •ì¸ ê²½ìš°
            else if (currentEvent.rrule) {
              recurringEvents.push(baseEvent);
              addDebugLog(`ë°˜ë³µ ì¼ì • ì €ì¥: ${baseEvent.title}`);
            }
            // ì¼ë°˜ ë‹¨ì¼ ì´ë²¤íŠ¸
            else if (!currentEvent.isException) {
              events.push(baseEvent);
            }
          }
          currentEvent = null;
        }
        else if (currentEvent) {
          const colonIndex = line.indexOf(':');
          if (colonIndex > 0) {
            const key = line.substring(0, colonIndex).split(';')[0];
            const value = line.substring(colonIndex + 1);
            
            switch (key) {
              case 'UID':
                currentEvent.uid = value;
                break;
              case 'SUMMARY':
                currentEvent.summary = decodeIcalText(value);
                break;
              case 'DESCRIPTION':
                currentEvent.description = decodeIcalText(value);
                break;
              case 'DTSTART':
                const startDate = parseIcalDate(value);
                if (startDate) {
                  currentEvent.dtstart = startDate.date;
                  currentEvent.date = startDate.date;
                  currentEvent.startTime = startDate.time;
                }
                break;
              case 'DTEND':
                const endDate = parseIcalDate(value);
                if (endDate) {
                  currentEvent.endTime = endDate.time;
                }
                break;
              case 'RRULE':
                currentEvent.rrule = value;
                addDebugLog(`RRULE ë°œê²¬: ${value}`);
                break;
              case 'EXDATE':
                if (!currentEvent.exdate) currentEvent.exdate = [];
                const parsed = parseIcalDate(value);
                if (parsed && parsed.date) {
                  currentEvent.exdate.push(parsed.date);
                }
                break;
              case 'RECURRENCE-ID':
                const recDate = parseIcalDate(value);
                if (recDate) {
                  currentEvent.recurrenceId = recDate.date;
                  currentEvent.isException = true;
                  addDebugLog(`RECURRENCE-ID íŒŒì‹±: ${currentEvent.recurrenceId}`);
                }
                break;
              case 'LOCATION':
                currentEvent.location = decodeIcalText(value);
                break;
            }
          }
        }
      }
      
      // ë°˜ë³µ ì¼ì • í™•ì¥
      const now = new Date();
      const viewStart = new Date(now.getFullYear() - 2, 0, 1);
      const viewEnd = new Date(now.getFullYear() + 2, 11, 31);
      
      addDebugLog(`ë·° ë²”ìœ„: ${viewStart.toISOString().split('T')[0]} ~ ${viewEnd.toISOString().split('T')[0]}`);
      
      recurringEvents.forEach(event => {
        const expandedEvents = expandRecurringEventWithExceptions(
          event, 
          viewStart, 
          viewEnd, 
          exceptionEvents
        );
        events.push(...expandedEvents);
      });
      
      addDebugLog(`iCal íŒŒì‹± ì™„ë£Œ: ${events.length}ê°œ ì´ë²¤íŠ¸ (ë°˜ë³µ ì¼ì • í¬í•¨)`);
      return events;
    }
    
    // ë°˜ë³µ ì¼ì • í™•ì¥ í•¨ìˆ˜ (ì™„ì „í•œ RRULE ì§€ì›)
    function expandRecurringEventWithExceptions(event, viewStart, viewEnd, exceptionEvents) {
      addDebugLog(`ë°˜ë³µ ì¼ì • í™•ì¥: ${event.title}, UID: ${event.uid}`);
      
      if (!event.uid) {
        event.uid = event.id;
      }
      
      const occurrences = [];
      let eventStart = new Date(event.date + 'T' + (event.startTime === 'ì¢…ì¼' ? '12:00:00' : event.startTime + ':00'));
      
      // RRULE íŒŒì‹±
      const rrule = event.rrule.replace('RRULE:', '').trim();
      const rules = {};
      rrule.split(';').forEach(part => {
        const [key, value] = part.split('=');
        if (key && value) {
          rules[key.trim()] = value.trim();
        }
      });
      
      // EXDATE ì²˜ë¦¬
      const excludedDates = new Set();
      if (event.exdate && Array.isArray(event.exdate)) {
        event.exdate.forEach(exdate => excludedDates.add(exdate));
      }
      
      // ì¢…ë£Œ ì¡°ê±´ íŒŒì‹±
      let untilDate = null;
      if (rules.UNTIL) {
        const parsed = parseIcalDate(rules.UNTIL);
        if (parsed) {
          untilDate = new Date(parsed.date + 'T23:59:59');
          addDebugLog(`UNTIL ë‚ ì§œ: ${untilDate.toISOString()}`);
        }
      }
      
      const maxCount = rules.COUNT ? parseInt(rules.COUNT) : null;
      const effectiveEndDate = untilDate ? (untilDate < viewEnd ? untilDate : viewEnd) : viewEnd;
      
      let current = new Date(eventStart.getTime());
      let totalGenerated = 0;
      let viewCount = 0;
      
      // BYDAY íŒŒì‹±
      let targetDays = null;
      if (rules.BYDAY) {
        const dayMap = {'SU': 0, 'MO': 1, 'TU': 2, 'WE': 3, 'TH': 4, 'FR': 5, 'SA': 6};
        targetDays = rules.BYDAY.split(',').map(day => dayMap[day.trim()]).filter(d => d !== undefined);
        addDebugLog(`BYDAY íŒŒì‹±: ${targetDays}`);
      }
      
      // ë·° ë²”ìœ„ ë‚´ ì´ë²¤íŠ¸ ìƒì„±
      while (current <= effectiveEndDate && viewCount < 200) {
        if (current >= viewStart) {
          const eventDateStr = current.toISOString().split('T')[0];
          const exceptionKey = `${event.uid}_${eventDateStr}`;
          
          // BYDAY ì²´í¬
          let includeEvent = true;
          if (targetDays && targetDays.length > 0) {
            includeEvent = targetDays.includes(current.getDay());
          }
          
          if (includeEvent && !excludedDates.has(eventDateStr)) {
            // ì˜ˆì™¸ ì´ë²¤íŠ¸ í™•ì¸
            if (exceptionEvents && exceptionEvents.has(exceptionKey)) {
              const modifiedEvent = exceptionEvents.get(exceptionKey);
              occurrences.push({
                ...modifiedEvent,
                isModified: true,
                originalUid: event.uid
              });
              if (viewCount < 3) addDebugLog(`ìˆ˜ì •ëœ ì¸ìŠ¤í„´ìŠ¤: ${eventDateStr}`);
            } else {
              occurrences.push({
                ...event,
                id: `${event.uid}_${current.getTime()}`,
                date: eventDateStr,
                isRecurring: true,
                originalUid: event.uid
              });
            }
            viewCount++;
          }
        }
        
        totalGenerated++;
        
        // COUNT ì²´í¬
        if (maxCount && totalGenerated >= maxCount) {
          addDebugLog(`COUNT ì œí•œ ë„ë‹¬: ${maxCount}`);
          break;
        }
        
        // ë‹¤ìŒ ë°˜ë³µìœ¼ë¡œ ì´ë™ (ë¬´í•œë£¨í”„ ë°©ì§€)
        const intervalValue = Math.max(parseInt(rules.INTERVAL) || 1, 1); // ìµœì†Œ 1
        
        switch (rules.FREQ) {
          case 'DAILY':
            current.setDate(current.getDate() + intervalValue);
            break;
          case 'WEEKLY':
            if (rules.BYDAY && targetDays) {
              // ë‹¤ìŒ íƒ€ê²Ÿ ìš”ì¼ ì°¾ê¸° (ì•ˆì „í•œ ë°©ì‹)
              let daysToAdd = 1;
              let found = false;
              
              for (let i = 1; i <= 7 * intervalValue; i++) {
                const nextDate = new Date(current);
                nextDate.setDate(current.getDate() + i);
                if (targetDays.includes(nextDate.getDay())) {
                  daysToAdd = i;
                  found = true;
                  break;
                }
              }
              
              if (!found) {
                daysToAdd = 7 * intervalValue; // ê¸°ë³¸ê°’
              }
              current.setDate(current.getDate() + daysToAdd);
            } else {
              current.setDate(current.getDate() + (7 * intervalValue));
            }
            break;
          case 'MONTHLY':
            current.setMonth(current.getMonth() + intervalValue);
            // ë‚ ì§œ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€
            if (current.getDate() !== eventStart.getDate()) {
              current.setDate(0); // í•´ë‹¹ ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ë¡œ ì„¤ì •
            }
            break;
          case 'YEARLY':
            current.setFullYear(current.getFullYear() + intervalValue);
            // ìœ¤ë…„ ì²˜ë¦¬
            if (current.getMonth() !== eventStart.getMonth() || current.getDate() !== eventStart.getDate()) {
              current.setDate(0);
            }
            break;
          default:
            addDebugLog(`ì•Œ ìˆ˜ ì—†ëŠ” FREQ: ${rules.FREQ}`);
            return occurrences;
        }
        
        // ë¬´í•œë£¨í”„ ë°©ì§€: ì‹œê°„ì´ ì œëŒ€ë¡œ ì§„í–‰ë˜ì§€ ì•Šìœ¼ë©´ ì¤‘ë‹¨
        if (current.getTime() <= eventStart.getTime()) {
          addDebugLog('ë°˜ë³µ ì¼ì • ìƒì„± ì¤‘ ì‹œê°„ ì§„í–‰ ì˜¤ë¥˜ë¡œ ì¤‘ë‹¨');
          break;
        }
      }
      
      addDebugLog(`ë°˜ë³µ ì¼ì • ì™„ë£Œ: ${occurrences.length}ê°œ (ì´ ${totalGenerated}ê°œ ì¤‘)`);
      return occurrences;
    }
    
    // iCal í…ìŠ¤íŠ¸ ë””ì½”ë”©
    function decodeIcalText(text) {
      return text
        .replace(/\\n/g, ' ')
        .replace(/\\,/g, ',')
        .replace(/\\;/g, ';')
        .replace(/\\\\/g, '\\')
        .trim();
    }
    


// iCal ë‚ ì§œ íŒŒì‹± (ì›ë³¸ ë‚ ì§œ ê·¸ëŒ€ë¡œ ì €ì¥)
function parseIcalDate(dateString) {
  try {
    // YYYYMMDD í˜•ì‹ (ì¢…ì¼ ì´ë²¤íŠ¸)
    if (/^\d{8}$/.test(dateString)) {
      const year = parseInt(dateString.substring(0, 4));
      const month = parseInt(dateString.substring(4, 6));
      const day = parseInt(dateString.substring(6, 8));
      
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      
      return {
        date: dateStr,
        time: 'ì¢…ì¼'
      };
    }
    
    // YYYYMMDDTHHMMSS[Z] í˜•ì‹ (ì‹œê°„ í¬í•¨)
    if (/^\d{8}T\d{6}Z?$/.test(dateString)) {
      const year = parseInt(dateString.substring(0, 4));
      const month = parseInt(dateString.substring(4, 6));
      const day = parseInt(dateString.substring(6, 8));
      const hour = parseInt(dateString.substring(9, 11));
      const minute = parseInt(dateString.substring(11, 13));
      
      let date;
      if (dateString.endsWith('Z')) {
        date = new Date(Date.UTC(year, month - 1, day, hour, minute));
      } else {
        date = new Date(year, month - 1, day, hour, minute);
      }
      
      // ì›ë³¸ ë‚ ì§œ ê·¸ëŒ€ë¡œ ì €ì¥ (6ì‹œ ê¸°ì¤€ ì¡°ì • ì œê±°)
      const eventDate = date.toLocaleDateString('en-CA');
      
      return {
        date: eventDate,
        time: date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false })
      };
    }
  } catch (e) {
    addDebugLog(`ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜: ${dateString} - ${e.message}`);
  }
  return null;
}

// ìº˜ë¦°ë” ìƒ‰ìƒ ì—…ë°ì´íŠ¸
function updateCalendarColor(calendarId, newColor) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.color = newColor;
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ìƒ‰ìƒ ë³€ê²½: ${calendar.name} â†’ ${newColor}`);
  }
}

// ìº˜ë¦°ë” ì´ë¦„ ì—…ë°ì´íŠ¸
function updateCalendarName(calendarId, newName) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar && newName.trim()) {
    calendar.name = newName.trim();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ì´ë¦„ ë³€ê²½: ${newName}`);
  }
}

function updateCalendarStatus(calendarId, status, message = '') {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.status = status;
    calendar.statusMessage = message;
    updateCalendarList();
  }
}

// ìº˜ë¦°ë” ëª©ë¡ ì—…ë°ì´íŠ¸
function updateCalendarList() {
  if (calendars.length === 0) {
    calendarList.innerHTML = `
      <p style="color: #666; font-size: 12px; text-align: center; padding: 20px;">
        ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ì—ì„œ ìº˜ë¦°ë”ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!
      </p>
    `;
    return;
  }
  
  calendarList.innerHTML = calendars.map(calendar => `

  `).join('');
  
  // ë·°ë³„ ìº˜ë¦°ë” ì„¤ì •ë„ ì—…ë°ì´íŠ¸
  updateViewCalendarSettings();
}

// ë·°ë³„ ìº˜ë¦°ë” ì„¤ì • ì—…ë°ì´íŠ¸
function updateViewCalendarSettings() {
  const container = document.getElementById('viewCalendarSettings');
  if (!container) return;
  
  if (calendars.length === 0) {
    container.innerHTML = '<p style="color: #666; font-size: 12px; text-align: center; padding: 10px;">ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  const views = [
    { key: 'day', name: 'ì¼ê°„ë·°' },
    { key: 'week', name: 'ì£¼ê°„ë·°' },
    { key: 'month', name: 'ì›”ê°„ë·°' }
  ];
  
  container.innerHTML = views.map(view => `
    <div class="view-calendar-section">
      <div style="font-weight: bold; margin-bottom: 8px; color: #333;">${view.name}</div>
      <div class="view-calendar-list">
        ${calendars.map(calendar => `
          <label class="view-calendar-item">
            <input type="checkbox" 
                   ${viewCalendarSettings[view.key].includes(calendar.id) ? 'checked' : ''}
                   onchange="toggleViewCalendar('${view.key}', '${calendar.id}')"
                   style="margin-right: 8px;">
            <span class="calendar-color-dot" style="background-color: ${calendar.color}; width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px;"></span>
            <span>${calendar.name}</span>
          </label>
        `).join('')}
      </div>
      <div style="margin-top: 8px;">
        <button class="btn btn-secondary" onclick="selectAllViewCalendars('${view.key}')" style="font-size: 11px; padding: 4px 8px;">ì „ì²´ ì„ íƒ</button>
        <button class="btn btn-secondary" onclick="deselectAllViewCalendars('${view.key}')" style="font-size: 11px; padding: 4px 8px; margin-left: 4px;">ì „ì²´ í•´ì œ</button>
      </div>
    </div>
  `).join('');
}

// ë·°ë³„ ìº˜ë¦°ë” í† ê¸€
function toggleViewCalendar(viewType, calendarId) {
  const index = viewCalendarSettings[viewType].indexOf(calendarId);
  if (index > -1) {
    viewCalendarSettings[viewType].splice(index, 1);
  } else {
    viewCalendarSettings[viewType].push(calendarId);
  }
  saveToStorage();
  renderCalendar();
  addDebugLog(`${viewType}ë·° ìº˜ë¦°ë” ì„¤ì • ë³€ê²½: ${calendarId}`);
}

// ì „ì²´ ì„ íƒ/í•´ì œ
function selectAllViewCalendars(viewType) {
  viewCalendarSettings[viewType] = calendars.map(cal => cal.id);
  updateViewCalendarSettings();
  saveToStorage();
  renderCalendar();
  addDebugLog(`${viewType}ë·° ëª¨ë“  ìº˜ë¦°ë” ì„ íƒ`);
}

function deselectAllViewCalendars(viewType) {
  viewCalendarSettings[viewType] = [];
  updateViewCalendarSettings();
  saveToStorage();
  renderCalendar();
  addDebugLog(`${viewType}ë·° ëª¨ë“  ìº˜ë¦°ë” í•´ì œ`);
}

// ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
async function reloadCalendar(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (!calendar) return;
  
  if (calendar.type === 'sample') {
    calendar.events = generateSampleEvents();
    updateCalendarStatus(calendarId, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìƒ˜í”Œ ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${calendar.name}`);
    return;
  }
  
  updateCalendarStatus(calendarId, 'loading', 'ìƒˆë¡œê³ ì¹¨ ì¤‘...');
  addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨: ${calendar.name}`);
  
  try {
    calendar.events = [];
    await loadCalendarEvents(calendar);
    updateCalendarStatus(calendarId, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${calendar.name}`);
  } catch (error) {
    updateCalendarStatus(calendarId, 'error', error.message);
    addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
  }
}

// ìº˜ë¦°ë” ê°€ì‹œì„± í† ê¸€
function toggleCalendarVisibility(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendar.visible = !calendar.visible;
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ê°€ì‹œì„± ë³€ê²½: ${calendar.name} - ${calendar.visible ? 'ë³´ì„' : 'ìˆ¨ê¹€'}`);
  }
}

// í† ê¸€ í•¨ìˆ˜
function toggleSection(contentId, iconId) {
  const content = document.getElementById(contentId);
  const icon = document.getElementById(iconId);
  
  content.classList.toggle('expanded');
  icon.classList.toggle('expanded');
}

// ìº˜ë¦°ë” ì‚­ì œ
function removeCalendar(calendarId) {
  const calendar = calendars.find(c => c.id === calendarId);
  if (calendar) {
    calendars = calendars.filter(c => c.id !== calendarId);
    
    // ë·°ë³„ ì„¤ì •ì—ì„œë„ ì œê±°
    Object.keys(viewCalendarSettings).forEach(view => {
      const index = viewCalendarSettings[view].indexOf(calendarId);
      if (index > -1) {
        viewCalendarSettings[view].splice(index, 1);
      }
    });
    
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    addDebugLog(`ìº˜ë¦°ë” ì‚­ì œë¨: ${calendar.name}`);
  }
}

// ìº˜ë¦°ë” ë Œë”ë§
function renderCalendar() {
  if (currentView === 'month') {
    renderMonthView();
  } else if (currentView === 'week') {
    renderWeekView();
  } else if (currentView === 'day') {
    renderDayView();
  }
}

// ì›”ê°„ ë·°
function renderMonthView() {
  const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  const startDate = new Date(firstDay);
  const mondayOffset = (firstDay.getDay() + 6) % 7;
  startDate.setDate(startDate.getDate() - mondayOffset);
  
  const grid = document.createElement('div');
  grid.className = 'calendar-grid month-view';
  
  // ìš”ì¼ í—¤ë”
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  weekdays.forEach(day => {
    const header = document.createElement('div');
    header.className = 'week-header';
    header.textContent = day;
    grid.appendChild(header);
  });
  
  // ë‚ ì§œ ì…€
  const effectiveToday = getEffectiveToday();
  for (let i = 0; i < 42; i++) {
    const cellDate = new Date(startDate);
    cellDate.setDate(startDate.getDate() + i);
    
    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    
    if (cellDate.getMonth() !== currentDate.getMonth()) {
      cell.classList.add('other-month');
    }
    
    if (cellDate.toDateString() === effectiveToday.toDateString()) {
      cell.classList.add('today');
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = cellDate.getDate();
    cell.appendChild(dayNumber);
    
    // 6ì‹œ ê¸°ì¤€ ì´ë²¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    const dayEvents = getEventsForEffectiveDate(cellDate);
    dayEvents.forEach(event => {
      const eventDiv = document.createElement('div');
      eventDiv.className = 'event';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\nì‹œê°„: ${event.startTime}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
      cell.appendChild(eventDiv);
    });
    
    grid.appendChild(cell);
  }
  
  calendarContent.innerHTML = '';
  calendarContent.appendChild(grid);
}

// ì£¼ê°„ ë·° (24ì‹œê°„ ê¸°ì¤€, ì •í™•í•œ ê·¸ë¦¬ë“œ ê³„ì‚°)
function renderWeekView() {
  const startOfWeek = new Date(currentDate);
  startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

  const container = document.createElement('div');
  container.style.padding = '20px';
  container.style.height = '600px';
  container.style.overflow = 'auto';

  const grid = document.createElement('div');
  grid.className = 'time-based-view week-view';
  
  // ì‹œê°„ í—¤ë”
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = 'ì‹œê°„';
  grid.appendChild(timeHeader);

  // ìš”ì¼ í—¤ë”
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  const effectiveToday = getEffectiveToday();
  
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);

    const header = document.createElement('div');
    header.className = 'week-header';

    if (date.toDateString() === effectiveToday.toDateString()) {
      header.classList.add('today');
    }

    const dayName = document.createElement('div');
    dayName.textContent = weekdays[i];
    dayName.style.fontWeight = 'bold';
    header.appendChild(dayName);

    const dayNumber = document.createElement('div');
    dayNumber.textContent = date.getDate();
    dayNumber.style.fontSize = '0.9em';
    dayNumber.style.color = '#666';
    header.appendChild(dayNumber);

    grid.appendChild(header);
  }

  // 24ì‹œê°„ ìŠ¬ë¡¯ê³¼ ì…€ë“¤ ìƒì„±
  const cells = {}; // {day: {hour: cell}} í˜•íƒœë¡œ ì €ì¥
  
  for (let hour = 0; hour < 24; hour++) {
    // ì‹œê°„ ë¼ë²¨
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
    grid.appendChild(timeSlot);

    // ê° ìš”ì¼ë³„ ì…€
    for (let day = 0; day < 7; day++) {
      const cell = document.createElement('div');
      cell.className = 'day-column';
      
      // ìƒˆë²½ ì‹œê°„ëŒ€ ë°°ê²½ìƒ‰
      if (hour < 6) {
        cell.style.backgroundColor = '#f9f9f9';
      }
      
      // ì…€ ì €ì¥
      if (!cells[day]) cells[day] = {};
      cells[day][hour] = cell;
      
      grid.appendChild(cell);
    }
  }

  // ì´ë²¤íŠ¸ ë Œë”ë§
  for (let day = 0; day < 7; day++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + day);

    const dayEvents = getEventsForEffectiveDate(date);
    const eventCounts = Array(24).fill(0); // ê° ì‹œê°„ë³„ ì´ë²¤íŠ¸ ê°œìˆ˜
    
    dayEvents.forEach(event => {
      if (event.startTime === 'ì¢…ì¼') {
        // ì¢…ì¼ ì´ë²¤íŠ¸
        const eventDiv = document.createElement('div');
        eventDiv.className = 'all-day-event';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\nì‹œê°„: ì¢…ì¼\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
        
        if (cells[day][0]) {
          cells[day][0].appendChild(eventDiv);
        }
      } else {
        // ì‹œê°„ ì´ë²¤íŠ¸
        const startHour = parseInt(event.startTime.split(':')[0]);
        const startMinute = parseInt(event.startTime.split(':')[1]);
        const endHour = parseInt(event.endTime.split(':')[0]);
        const endMinute = parseInt(event.endTime.split(':')[1]);
        
        // í¬ë¡œìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ ì²˜ë¦¬ (23:00-02:00 ë“±)
        if (endHour < startHour || (endHour === startHour && endMinute <= startMinute)) {
          // ì²« ë²ˆì§¸ ë¶€ë¶„: ì‹œì‘ì‹œê°„ ~ 23:59
          const firstEventDiv = document.createElement('div');
          firstEventDiv.className = 'time-event';
          firstEventDiv.style.backgroundColor = event.color;
          firstEventDiv.textContent = event.title;
          firstEventDiv.title = `${event.title}\nì‹œê°„: ${event.startTime} - ë‹¤ìŒë‚  ${event.endTime}\nìº˜ë¦°ë”: ${event.calendarName}`;
          
          const firstDuration = 24 - startHour - (startMinute / 60);
          const topOffset = (startMinute / 25) * 100;
          const height = firstDuration * 25;
          
          firstEventDiv.style.top = `${topOffset}%`;
          firstEventDiv.style.height = `${height}px`;
          firstEventDiv.style.left = '2px';
          firstEventDiv.style.right = '2px';
          
          if (cells[day][startHour]) {
            cells[day][startHour].appendChild(firstEventDiv);
          }
          
          // ë‘ ë²ˆì§¸ ë¶€ë¶„: ë‹¤ìŒë‚  00:00 ~ ëì‹œê°„
          const nextDay = (day + 1) % 7;
          if (cells[nextDay]) {
            for (let h = 0; h <= endHour; h++) {
              if (cells[nextDay][h]) {
                const secondEventDiv = document.createElement('div');
                secondEventDiv.className = 'time-event';
                secondEventDiv.style.backgroundColor = event.color;
                secondEventDiv.textContent = event.title;
                secondEventDiv.title = `${event.title}\nì‹œê°„: ì „ë‚  ${event.startTime} - ${event.endTime}\nìº˜ë¦°ë”: ${event.calendarName}`;
                
                let height;
                if (h < endHour) {
                  height = 25; // ì „ì²´ ì‹œê°„
                } else {
                  height = (endMinute / 60) * 25; // ë§ˆì§€ë§‰ ì‹œê°„ì˜ ì¼ë¶€
                }
                
                secondEventDiv.style.top = '0px';
                secondEventDiv.style.height = `${height}px`;
                secondEventDiv.style.left = '2px';
                secondEventDiv.style.right = '2px';
                
                cells[nextDay][h].appendChild(secondEventDiv);
              }
            }
          }
        } else {
          // ì¼ë°˜ ì´ë²¤íŠ¸
          const currentEventIndex = eventCounts[startHour];
          eventCounts[startHour]++;
          
          const duration = (endHour - startHour) + ((endMinute - startMinute) / 60);
          
          const eventDiv = document.createElement('div');
          eventDiv.className = 'time-event';
          eventDiv.style.backgroundColor = event.color;
          eventDiv.textContent = event.title;
          eventDiv.title = `${event.title}\nì‹œê°„: ${event.startTime} - ${event.endTime}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
          
          // ê²¹ì¹˜ëŠ” ì´ë²¤íŠ¸ ì²˜ë¦¬
          const totalEvents = Math.max(eventCounts[startHour], 1);
          const eventWidth = Math.floor(100 / totalEvents);
          const leftPosition = currentEventIndex * eventWidth;
          
          const topOffset = (startMinute / 60) * 25;
          const height = Math.max(duration * 25, 20);
          
          eventDiv.style.top = `${topOffset}px`;
          eventDiv.style.height = `${height}px`;
          eventDiv.style.left = `${leftPosition}%`;
          eventDiv.style.width = `${eventWidth}%`;
          eventDiv.style.zIndex = 100 + currentEventIndex;
          
          if (cells[day][startHour]) {
            cells[day][startHour].appendChild(eventDiv);
          }
        }
      }
    });
  }

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// ì¼ê°„ ë·° (24ì‹œê°„ ê¸°ì¤€, ì •í™•í•œ ê·¸ë¦¬ë“œ ê³„ì‚°)
function renderDayView() {
  const container = document.createElement('div');
  container.style.padding = '20px';
  container.style.height = '600px';
  container.style.overflow = 'auto';

  const grid = document.createElement('div');
  grid.className = 'time-based-view day-view';

  // í—¤ë”
  const timeHeader = document.createElement('div');
  timeHeader.className = 'week-header';
  timeHeader.textContent = 'ì‹œê°„';
  grid.appendChild(timeHeader);

  const dayHeader = document.createElement('div');
  dayHeader.className = 'week-header';
  
  const effectiveToday = getEffectiveToday();
  if (currentDate.toDateString() === effectiveToday.toDateString()) {
    dayHeader.classList.add('today');
  }

  const options = { month: 'short', day: 'numeric', weekday: 'short' };
  dayHeader.textContent = currentDate.toLocaleDateString('ko-KR', options);
  grid.appendChild(dayHeader);

  // 24ì‹œê°„ ìŠ¬ë¡¯ê³¼ ì…€ë“¤ ìƒì„±
  const cells = {}; // {hour: cell} í˜•íƒœë¡œ ì €ì¥
  
  for (let hour = 0; hour < 24; hour++) {
    const timeSlot = document.createElement('div');
    timeSlot.className = 'time-slot';
    timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
    grid.appendChild(timeSlot);

    const cell = document.createElement('div');
    cell.className = 'day-column';
    
    // ìƒˆë²½ ì‹œê°„ëŒ€ ë°°ê²½ìƒ‰
    if (hour < 6) {
      cell.style.backgroundColor = '#f9f9f9';
    }
    
    cells[hour] = cell;
    grid.appendChild(cell);
  }

  // ì´ë²¤íŠ¸ ë Œë”ë§
  const dayEvents = getEventsForEffectiveDate(currentDate);
  const eventCounts = Array(24).fill(0);
  
  dayEvents.forEach(event => {
    if (event.startTime === 'ì¢…ì¼') {
      // ì¢…ì¼ ì´ë²¤íŠ¸
      const eventDiv = document.createElement('div');
      eventDiv.className = 'all-day-event';
      eventDiv.style.backgroundColor = event.color;
      eventDiv.textContent = event.title;
      eventDiv.title = `${event.title}\nì‹œê°„: ì¢…ì¼\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
      
      if (cells[0]) {
        cells[0].appendChild(eventDiv);
      }
    } else {
      // ì‹œê°„ ì´ë²¤íŠ¸
      const startHour = parseInt(event.startTime.split(':')[0]);
      const startMinute = parseInt(event.startTime.split(':')[1]);
      const endHour = parseInt(event.endTime.split(':')[0]);
      const endMinute = parseInt(event.endTime.split(':')[1]);
      
      // í¬ë¡œìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ ì²˜ë¦¬
      if (endHour < startHour || (endHour === startHour && endMinute <= startMinute)) {
        // ì²« ë²ˆì§¸ ë¶€ë¶„: ì‹œì‘ì‹œê°„ ~ 23:59
        const firstEventDiv = document.createElement('div');
        firstEventDiv.className = 'time-event';
        firstEventDiv.style.backgroundColor = event.color;
        firstEventDiv.textContent = event.title;
        firstEventDiv.title = `${event.title}\nì‹œê°„: ${event.startTime} - ë‹¤ìŒë‚  ${event.endTime}\nìº˜ë¦°ë”: ${event.calendarName}`;
        
        const firstDuration = 24 - startHour - (startMinute / 60);
        const topOffset = (startMinute / 60) * 25;
        const height = firstDuration * 25;
        
        firstEventDiv.style.position = 'absolute';
        firstEventDiv.style.top = `${topOffset}px`;
        firstEventDiv.style.height = `${height}px`;
        firstEventDiv.style.left = '2px';
        firstEventDiv.style.right = '2px';
        
        if (cells[startHour]) {
          cells[startHour].appendChild(firstEventDiv);
        }
        
        // ë‘ ë²ˆì§¸ ë¶€ë¶„: 00:00 ~ ëì‹œê°„
        for (let h = 0; h <= endHour; h++) {
          if (cells[h]) {
            const secondEventDiv = document.createElement('div');
            secondEventDiv.className = 'time-event';
            secondEventDiv.style.backgroundColor = event.color;
            secondEventDiv.textContent = event.title;
            secondEventDiv.title = `${event.title}\nì‹œê°„: ì „ë‚  ${event.startTime} - ${event.endTime}\nìº˜ë¦°ë”: ${event.calendarName}`;
            
            let height;
            if (h < endHour) {
              height = 25; // ì „ì²´ ì‹œê°„
            } else {
              height = (endMinute / 60) * 25; // ë§ˆì§€ë§‰ ì‹œê°„ì˜ ì¼ë¶€
            }
            
            secondEventDiv.style.position = 'absolute';
            secondEventDiv.style.top = '0px';
            secondEventDiv.style.height = `${height}px`;
            secondEventDiv.style.left = '2px';
            secondEventDiv.style.right = '2px';
            
            cells[h].appendChild(secondEventDiv);
          }
        }
      } else {
        // ì¼ë°˜ ì´ë²¤íŠ¸
        const currentEventIndex = eventCounts[startHour];
        eventCounts[startHour]++;
        
        const duration = (endHour - startHour) + ((endMinute - startMinute) / 60);
        
        const eventDiv = document.createElement('div');
        eventDiv.className = 'time-event';
        eventDiv.style.backgroundColor = event.color;
        eventDiv.textContent = event.title;
        eventDiv.title = `${event.title}\nì‹œê°„: ${event.startTime} - ${event.endTime}\nìº˜ë¦°ë”: ${event.calendarName}${event.location ? '\nìœ„ì¹˜: ' + event.location : ''}${event.description ? '\nì„¤ëª…: ' + event.description : ''}`;
        
        // ê²¹ì¹˜ëŠ” ì´ë²¤íŠ¸ ì²˜ë¦¬
        const totalEvents = Math.max(eventCounts[startHour], 1);
        const eventWidth = Math.floor(100 / totalEvents);
        const leftPosition = currentEventIndex * eventWidth;
        
        const topOffset = (startMinute / 60) * 25;
        const height = Math.max(duration * 25, 20);
        
        eventDiv.style.position = 'absolute';
        eventDiv.style.top = `${topOffset}px`;
        eventDiv.style.height = `${height}px`;
        eventDiv.style.left = `${leftPosition}%`;
        eventDiv.style.width = `${eventWidth}%`;
        eventDiv.style.zIndex = 100 + currentEventIndex;
        
        if (cells[startHour]) {
          cells[startHour].appendChild(eventDiv);
        }
      }
    }
  });

  container.appendChild(grid);
  calendarContent.innerHTML = '';
  calendarContent.appendChild(container);
}

// ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
async function refreshAllCalendars() {
  addDebugLog('ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
  
  for (const calendar of calendars) {
    if (calendar.type !== 'sample') {
      updateCalendarStatus(calendar.id, 'loading', 'ìƒˆë¡œê³ ì¹¨ ì¤‘...');
      try {
        calendar.events = [];
        await loadCalendarEvents(calendar);
        updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
      } catch (error) {
        updateCalendarStatus(calendar.id, 'error', error.message);
        addDebugLog(`ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
      }
    }
  }
  
  renderCalendar();
  saveToStorage();
  addDebugLog('ëª¨ë“  ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}

// ìº˜ë¦°ë” ì¶”ê°€ (ë·°ë³„ ì„¤ì • ìë™ ì¶”ê°€ í¬í•¨)
async function addCalendar() {
  const type = document.getElementById('calendarType').value;
  const name = document.getElementById('calendarName').value.trim();
  const color = document.getElementById('calendarColor').value;
  
  if (!name) {
    alert('ìº˜ë¦°ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  let url = '';
  let calendarId = '';
  let apiKey = '';
  
  if (type === 'ical') {
    url = document.getElementById('icalUrl').value.trim();
    if (!url || !url.includes('.ics')) {
      alert('ì˜¬ë°”ë¥¸ iCal ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  } else if (type === 'googlePublic') {
    calendarId = document.getElementById('googleCalendarId').value.trim();
    if (!calendarId) {
      alert('êµ¬ê¸€ ìº˜ë¦°ë” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  } else if (type === 'api') {
    apiKey = document.getElementById('apiKey').value.trim();
    calendarId = document.getElementById('calendarId').value.trim() || 'primary';
    if (!apiKey) {
      alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
  }
  
  const calendar = {
    id: Date.now().toString(),
    name: name,
    type: type,
    color: color,
    visible: true,
    url: url,
    calendarId: calendarId,
    apiKey: apiKey,
    events: [],
    status: 'loading',
    statusMessage: 'ë¡œë”© ì¤‘...'
  };
  
  addDebugLog(`ìº˜ë¦°ë” ì¶”ê°€ ì‹œì‘: ${name} (${type})`);
  
  calendars.push(calendar);
  
  // ëª¨ë“  ë·°ì— ìƒˆ ìº˜ë¦°ë” ìë™ ì¶”ê°€
  Object.keys(viewCalendarSettings).forEach(view => {
    viewCalendarSettings[view].push(calendar.id);
  });
  
  updateCalendarList();
  
  try {
    await loadCalendarEvents(calendar);
    updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    addDebugLog(`ìº˜ë¦°ë” ë¡œë“œ ì„±ê³µ: ${name}, ${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
    renderCalendar();
    saveToStorage();
    
    // ì…ë ¥ í¼ ì´ˆê¸°í™”
    document.getElementById('calendarName').value = '';
    document.getElementById('icalUrl').value = '';
    document.getElementById('googleCalendarId').value = '';
    document.getElementById('apiKey').value = '';
    document.getElementById('calendarId').value = '';
    
    closeSettings();
  } catch (error) {
    updateCalendarStatus(calendar.id, 'error', error.message);
    addDebugLog(`ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${name} - ${error.message}`);
    alert('ìº˜ë¦°ë”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

// ìƒ˜í”Œ ìº˜ë¦°ë” ì¶”ê°€ (ë·°ë³„ ì„¤ì • ìë™ ì¶”ê°€ í¬í•¨)
function addSampleCalendar() {
  const sampleCalendar = {
    id: 'sample-' + Date.now(),
    name: 'ìƒ˜í”Œ ìº˜ë¦°ë”',
    type: 'sample',
    color: calendarColors[calendars.length % calendarColors.length],
    visible: true,
    events: generateSampleEvents(),
    status: 'success',
    statusMessage: 'ìƒ˜í”Œ ë°ì´í„°'
  };
  
  calendars.push(sampleCalendar);
  
  // ëª¨ë“  ë·°ì— ìƒˆ ìº˜ë¦°ë” ìë™ ì¶”ê°€
  Object.keys(viewCalendarSettings).forEach(view => {
    viewCalendarSettings[view].push(sampleCalendar.id);
  });
  
  updateCalendarList();
  renderCalendar();
  saveToStorage();
  addDebugLog('ìƒ˜í”Œ ìº˜ë¦°ë”ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// í•œêµ­ ê³µíœ´ì¼ ì¶”ê°€ (ë·°ë³„ ì„¤ì • ìë™ ì¶”ê°€ í¬í•¨)
function addKoreanHolidays() {
  const holidayCalendar = {
    id: 'korean-holidays-' + Date.now(),
    name: 'í•œêµ­ ê³µíœ´ì¼',
    type: 'googlePublic',
    color: '#ea4335',
    visible: true,
    calendarId: 'ko.south_korea#holiday@group.v.calendar.google.com',
    events: [],
    status: 'loading',
    statusMessage: 'ë¡œë”© ì¤‘...'
  };
  
  calendars.push(holidayCalendar);
  
  // ëª¨ë“  ë·°ì— ìƒˆ ìº˜ë¦°ë” ìë™ ì¶”ê°€
  Object.keys(viewCalendarSettings).forEach(view => {
    viewCalendarSettings[view].push(holidayCalendar.id);
  });
  
  updateCalendarList();
  
  loadCalendarEvents(holidayCalendar)
    .then(() => {
      updateCalendarStatus(holidayCalendar.id, 'success', `${holidayCalendar.events.length}ê°œ ì´ë²¤íŠ¸`);
      renderCalendar();
      saveToStorage();
      addDebugLog('í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ì¶”ê°€ ì™„ë£Œ');
    })
    .catch(error => {
      updateCalendarStatus(holidayCalendar.id, 'error', error.message);
      addDebugLog(`í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
    });
}

// ìƒ˜í”Œ ì´ë²¤íŠ¸ ìƒì„± (ì§„ì§œ 6ì‹œ ê¸°ì¤€ ì ìš©)
function generateSampleEvents() {
  const events = [];
  const today = getEffectiveToday();
  const todayStr = today.toISOString().split('T')[0];
  
  // ì‹¤ì œ ë‹¤ìŒë‚  (6ì‹œ ê¸°ì¤€ ë‚´ì¼)
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split('T')[0];
  
  // ì˜¤ëŠ˜ ì˜¤ì „ ì´ë²¤íŠ¸ë“¤ (6ì‹œ ì´í›„)
  events.push({
    id: 'sample1',
    title: 'ì•„ì¹¨ ìš´ë™',
    date: todayStr,
    startTime: '07:00',
    endTime: '08:00',
    description: 'í—¬ìŠ¤ì¥ì—ì„œ ìš´ë™',
    location: 'í”¼íŠ¸ë‹ˆìŠ¤ì„¼í„°'
  });
  
  events.push({
    id: 'sample2',
    title: 'íŒ€ íšŒì˜',
    date: todayStr,
    startTime: '10:00',
    endTime: '11:30',
    description: 'ì£¼ê°„ ì—…ë¬´ íšŒì˜',
    location: 'íšŒì˜ì‹¤ A'
  });
  
  events.push({
    id: 'sample3',
    title: 'ì ì‹¬ ì•½ì†',
    date: todayStr,
    startTime: '12:30',
    endTime: '14:00',
    description: 'ì¹œêµ¬ì™€ ì ì‹¬ì‹ì‚¬',
    location: 'ì´íƒˆë¦¬ì•ˆ ë ˆìŠ¤í† ë‘'
  });
  
  // 6ì‹œ ê¸°ì¤€ í•˜ë£¨ ë‚´ í¬ë¡œìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ (23:00-02:00)
  events.push({
    id: 'sample4',
    title: 'ì‹¬ì•¼ ì‘ì—…',
    date: todayStr,
    startTime: '23:00',
    endTime: '02:00',
    description: 'í”„ë¡œì íŠ¸ ë§ˆë¬´ë¦¬ (6ì‹œ ê¸°ì¤€ ê°™ì€ í•˜ë£¨)',
    location: 'í™ˆì˜¤í”¼ìŠ¤'
  });
  
  // ì˜¤ëŠ˜ì˜ ìƒˆë²½ ì´ë²¤íŠ¸ (6ì‹œ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ëŠ˜ì— ì†í•¨)
  // ì‹¤ì œë¡œëŠ” ë‚´ì¼ ìƒˆë²½ì´ì§€ë§Œ 6ì‹œ ê¸°ì¤€ìœ¼ë¡œëŠ” ì˜¤ëŠ˜
  events.push({
    id: 'sample5',
    title: 'ìƒˆë²½ ì¡°ê¹…',
    date: tomorrowStr,  // ì‹¤ì œ ë‚´ì¼ ìƒˆë²½
    startTime: '05:30',
    endTime: '06:30',
    description: 'í•œê°• ì¡°ê¹… (6ì‹œ ê¸°ì¤€ ì˜¤ëŠ˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸)',
    location: 'í•œê°•ê³µì›'
  });
  
  // ì§„ì§œ ë‚´ì¼ ì´ë²¤íŠ¸ (6ì‹œ ê¸°ì¤€ ë‚´ì¼)
  events.push({
    id: 'sample6',
    title: 'ì¢…ì¼ ì„¸ë¯¸ë‚˜',
    date: tomorrowStr,
    startTime: 'ì¢…ì¼',
    endTime: 'ì¢…ì¼',
    description: 'AI ê¸°ìˆ  ì„¸ë¯¸ë‚˜',
    location: 'ì½”ì—‘ìŠ¤'
  });
  
  events.push({
    id: 'sample7',
    title: 'ì˜¤ì „ ë¯¸íŒ…',
    date: tomorrowStr,
    startTime: '09:00',
    endTime: '10:00',
    description: '6ì‹œ ê¸°ì¤€ ë‚´ì¼ ì´ë²¤íŠ¸',
    location: 'ì‚¬ë¬´ì‹¤'
  });
  
  return events;
}

// ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
function saveToStorage() {
  try {
    const data = {
      view: currentView,
      currentDate: currentDate.toISOString(),
      accentColor: accentColor,
      accentHoverColor: accentHoverColor,
      viewCalendarSettings: viewCalendarSettings,
      calendars: calendars.map(cal => ({
        ...cal,
        events: cal.events || []
      }))
    };
    
    localStorage.setItem('multiCalendarData', JSON.stringify(data));
    addDebugLog('ì„¤ì •ì´ localStorageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    addDebugLog(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
  }
}

function loadFromStorage() {
  try {
    const data = localStorage.getItem('multiCalendarData');
    if (data) {
      const parsed = JSON.parse(data);
      currentView = parsed.view || 'day';
      if (parsed.currentDate) {
        currentDate = new Date(parsed.currentDate);
        // ì €ì¥ëœ ë‚ ì§œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ 6ì‹œ ê¸°ì¤€ ì˜¤ëŠ˜ë¡œ ì„¤ì •
        if (isNaN(currentDate.getTime())) {
          currentDate = getEffectiveToday();
        }
      }
      accentColor = parsed.accentColor || '#4285f4';
      accentHoverColor = parsed.accentHoverColor || darkenColor(accentColor, 15);
      viewCalendarSettings = parsed.viewCalendarSettings || { day: [], week: [], month: [] };
      calendars = parsed.calendars || [];
      
      // UI ë³µì›
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(currentView + 'Btn').classList.add('active');
      
      // ì €ì¥ëœ ìº˜ë¦°ë”ë“¤ì˜ ì´ë²¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ
      calendars.forEach(async (calendar) => {
        if (calendar.type !== 'sample' && (!calendar.events || calendar.events.length === 0)) {
          updateCalendarStatus(calendar.id, 'loading', 'ë¡œë”© ì¤‘...');
          try {
            await loadCalendarEvents(calendar);
            updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
          } catch (error) {
            updateCalendarStatus(calendar.id, 'error', error.message);
            addDebugLog(`ì €ì¥ëœ ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
          }
        } else {
          updateCalendarStatus(calendar.id, 'success', `${(calendar.events || []).length}ê°œ ì´ë²¤íŠ¸`);
        }
      });
      
      addDebugLog('ì„¤ì •ì´ localStorageì—ì„œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  } catch (e) {
    addDebugLog(`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}`);
  }
}

// ì„¤ì • ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°
function exportCalendarSettings() {
  try {
    const exportData = {
      version: '2.0',
      exportDate: new Date().toISOString(),
      view: currentView,
      currentDate: currentDate.toISOString(),
      accentColor: accentColor,
      accentHoverColor: accentHoverColor,
      viewCalendarSettings: viewCalendarSettings,
      calendars: calendars.map(cal => ({
        id: cal.id,
        name: cal.name,
        type: cal.type,
        color: cal.color,
        visible: cal.visible,
        url: cal.url,
        calendarId: cal.calendarId,
        apiKey: cal.apiKey,
        status: cal.status,
        statusMessage: cal.statusMessage
      }))
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `ìº˜ë¦°ë”ì„¤ì •_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    addDebugLog(`ìº˜ë¦°ë” ì„¤ì • ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: ${calendars.length}ê°œ ìº˜ë¦°ë”`);
    alert('ìº˜ë¦°ë” ì„¤ì •ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
    
  } catch (error) {
    addDebugLog(`ì„¤ì • ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${error.message}`);
    alert('ì„¤ì • ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

async function importCalendarSettings(fileInput) {
  const file = fileInput.files[0];
  if (!file) return;
  
  try {
    const text = await file.text();
    const importData = JSON.parse(text);
    
    if (!importData.version) {
      throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.');
    }
    
    addDebugLog(`ì„¤ì • íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì‹œì‘: ${importData.calendars?.length || 0}ê°œ ìº˜ë¦°ë”`);
    
    // ê¸°ì¡´ ìº˜ë¦°ë” ë°±ì—… (sample ì œì™¸)
    const backupCalendars = calendars.filter(cal => cal.type === 'sample');
    
    // ì„¤ì • ë³µì›
    currentView = importData.view || 'day';
    if (importData.currentDate) {
      currentDate = new Date(importData.currentDate);
      if (isNaN(currentDate.getTime())) {
        currentDate = getEffectiveToday();
      }
    }
    if (importData.accentColor) {
      setAccentColor(importData.accentColor);
    }
    if (importData.viewCalendarSettings) {
      viewCalendarSettings = importData.viewCalendarSettings;
    }
    
    // ìº˜ë¦°ë” ë³µì›
    calendars = [...backupCalendars];
    
    if (importData.calendars && Array.isArray(importData.calendars)) {
      for (const calData of importData.calendars) {
        if (calData.type === 'sample') continue;
        
        const calendar = {
          id: calData.id || Date.now().toString() + Math.random(),
          name: calData.name || 'ì´ë¦„ ì—†ìŒ',
          type: calData.type,
          color: calData.color || '#4285f4',
          visible: calData.visible !== false,
          url: calData.url,
          calendarId: calData.calendarId,
          apiKey: calData.apiKey,
          events: [],
          status: 'loading',
          statusMessage: 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'
        };
        
        calendars.push(calendar);
        updateCalendarStatus(calendar.id, 'loading', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        try {
          await loadCalendarEvents(calendar);
          updateCalendarStatus(calendar.id, 'success', `${calendar.events.length}ê°œ ì´ë²¤íŠ¸`);
          addDebugLog(`ìº˜ë¦°ë” ë³µì› ì„±ê³µ: ${calendar.name}`);
        } catch (error) {
          updateCalendarStatus(calendar.id, 'error', error.message);
          addDebugLog(`ìº˜ë¦°ë” ë³µì› ì‹¤íŒ¨: ${calendar.name} - ${error.message}`);
        }
      }
    }
    
    // UI ì—…ë°ì´íŠ¸
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(currentView + 'Btn').classList.add('active');
    
    updateCurrentDateDisplay();
    updateCalendarList();
    renderCalendar();
    saveToStorage();
    
    addDebugLog('ìº˜ë¦°ë” ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
    alert(`ìº˜ë¦°ë” ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.\në³µì›ëœ ìº˜ë¦°ë”: ${importData.calendars?.length || 0}ê°œ`);
    
  } catch (error) {
    addDebugLog(`ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`);
    alert('ì„¤ì • íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
  
  fileInput.value = '';
}

// ì´ˆê¸°í™” ì‹¤í–‰
init();

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  
  switch(e.key) {
    case 'ArrowLeft':
      navigateCalendar(-1);
      e.preventDefault();
      break;
    case 'ArrowRight':
      navigateCalendar(1);
      e.preventDefault();
      break;
    case 't':
    case 'T':
      goToToday();
      break;
    case 'm':
    case 'M':
      setView('month');
      break;
    case 'w':
    case 'W':
      setView('week');
      break;
    case 'd':
    case 'D':
      setView('day');
      break;
    case 'Escape':
      closeSettings();
      break;
  }
});

// ìº˜ë¦°ë” ìƒ‰ìƒ ìë™ í• ë‹¹
document.getElementById('calendarColor').addEventListener('focus', function() {
  this.value = calendarColors[calendars.length % calendarColors.length];
});

// ë””ë²„ê·¸ìš© í•¨ìˆ˜ë“¤
window.debugCalendar = {
  showCalendars: () => console.table(calendars),
  showEvents: (calendarId) => {
    const calendar = calendars.find(c => c.id === calendarId || c.name === calendarId);
    if (calendar) {
      console.table(calendar.events);
    } else {
      console.log('ìº˜ë¦°ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  },
  clearStorage: () => {
    localStorage.removeItem('multiCalendarData');
    location.reload();
  },
  addSampleCalendar: addSampleCalendar,
  addKoreanHolidays: addKoreanHolidays,
  getEffectiveToday: getEffectiveToday,
  currentDate: () => currentDate,
  testSixAmLogic: () => {
    const now = new Date();
    const effective = getEffectiveToday();
    console.log('í˜„ì¬ ì‹œê°„:', now.toLocaleString());
    console.log('6ì‹œ ê¸°ì¤€ ì˜¤ëŠ˜:', effective.toLocaleDateString());
    console.log('í˜„ì¬ ë³´ê³  ìˆëŠ” ë‚ ì§œ:', currentDate.toLocaleDateString());
  }
};

// ë„ì›€ë§ í‘œì‹œ
console.log('%c6ì‹œ ê¸°ì¤€ ë©€í‹° ìº˜ë¦°ë” ë·°ì–´%c\n' +
  '- ì˜¤ì „ 6ì‹œë¥¼ í•˜ë£¨ì˜ ì‹œì‘ìœ¼ë¡œ ê°„ì£¼\n' +
  '- ìƒˆë²½ 0-6ì‹œëŠ” ì „ë‚ ì˜ ì—°ì¥ìœ¼ë¡œ ì²˜ë¦¬\n' +
  '- ë°˜ë³µ ì¼ì •, ì˜ˆì™¸ ì´ë²¤íŠ¸ ì™„ì „ ì§€ì›\n' +
  'debugCalendar.testSixAmLogic() - 6ì‹œ ê¸°ì¤€ ë¡œì§ í…ŒìŠ¤íŠ¸\n' +
  'debugCalendar.getEffectiveToday() - í˜„ì¬ 6ì‹œ ê¸°ì¤€ ë‚ ì§œ\n' +
  'debugCalendar.currentDate() - ë³´ê³  ìˆëŠ” ë‚ ì§œ', 
  'color: #4285f4; font-weight: bold; font-size: 14px;', 
  'color: #333; font-size: 12px;');
</script>
</body>
</html>  

